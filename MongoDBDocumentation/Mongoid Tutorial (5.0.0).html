<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><script src="Mongoid%20Tutorial%20%285.0.0%29_files/async-ads.js" async=""></script>
  <link href="Mongoid%20Tutorial%20%285.0.0%29_files/css.css" rel="stylesheet" type="text/css">
    <title>Mongoid Tutorial (5.0.0)</title><link rel="shortcut icon" href="https://media.mongodb.org/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="robots" content="index">
  <meta name="release" content="2.6.0">
  <meta name="version" content="2.6.0">
  <meta name="DC.Source" content="https://github.com/mongodb/docs-ecosystem/blob/master/source/tutorial/ruby-mongoid-tutorial.txt">
  
       <link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/bootstrap-custom.css" type="text/css">
       <link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/icomoon.css" type="text/css">
       <link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/font-awesome.css" type="text/css">
       <link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/tipsy.css" type="text/css">
   <link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/mongodb-docs.css" type="text/css">
   <link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/pygments.css" type="text/css">
    
  <script src="Mongoid%20Tutorial%20%285.0.0%29_files/insight.js" async="" type="text/javascript"></script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/elqCfg.js" async="" type="text/javascript"></script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/analytics.js" async="" type="text/javascript"></script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/conversion_async.js" async="" type="text/javascript"></script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/gtm.js" async=""></script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/cse.js" async="" type="text/javascript"></script><script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
     URL_ROOT:    '../../',
     VERSION:     '2.6.0',
     COLLAPSE_INDEX: false,
     FILE_SUFFIX: '',
     HAS_SOURCE:  false,
    };
  </script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/jquery.js"></script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/underscore.js"></script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/doctools.js"></script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/bootstrap.js"></script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/jquery_002.js"></script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/jquery_003.js"></script>
    <script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/navbar.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.org/osd.xml" title="MongoDB Help">
<link rel="top" title="MongoDB Ecosystem" href="http://docs.mongodb.org/ecosystem/">
<link rel="up" title="Ruby MongoDB Driver" href="http://docs.mongodb.org/ecosystem/drivers/ruby/">
<link rel="next" title="Scala MongoDB Driver" href="http://docs.mongodb.org/ecosystem/drivers/scala/">
<link rel="prev" title="Ruby BSON Tutorial (3.0.0)" href="http://docs.mongodb.org/ecosystem/tutorial/ruby-bson-tutorial/">
      <script type="text/javascript">
        (function() {
           var cx = '017213726194841070573:WMX6838984';
           var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
           gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
           gcse.onload = gcse.onreadystatechange = function() {
            $(function() {
              // hack to set a placeholder in google's custom search input
              var pollInput = window.setInterval(function() {
                var $input = $('.gsc-input input.gsc-input'),
                    $div = $('.search-db');

                if ($input.length) {
                  $input.on('focus', function(e) { $div.addClass('wide').removeClass('narrow'); });
                  $input.on('blur', function(e) {
                    if (!$input.val().length) { $div.addClass('narrow').removeClass('wide'); }
                  });
                  $input.attr('placeholder', "Search mongodb.org");
                  window.clearInterval(pollInput);
                }
              }, 10);
            });
           };
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
           })();
      </script><script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/jsapi"></script><link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/defaulten.css" type="text/css"><link rel="stylesheet" href="Mongoid%20Tutorial%20%285.0.0%29_files/default.css" type="text/css"><script src="Mongoid%20Tutorial%20%285.0.0%29_files/defaulten.js" type="text/javascript"></script><style type="text/css">
.gsc-control-cse {
font-family: Arial, sans-serif;
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-control-cse .gsc-table-result {
font-family: Arial, sans-serif;
}
input.gsc-input, .gsc-input-box, .gsc-input-box-hover, .gsc-input-box-focus {
border-color: #D9D9D9;
}
input.gsc-search-button, input.gsc-search-button:hover, input.gsc-search-button:focus {
border-color: #5AAC41;
background-color: #5AAC41;
background-image: none;
filter: none;
}
.gsc-tabHeader.gsc-tabhInactive {
border-color: #CCCCCC;
background-color: #FFFFFF;
}
.gsc-tabHeader.gsc-tabhActive {
border-color: #CCCCCC;
border-bottom-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-tabsArea {
border-color: #CCCCCC;
}
.gsc-webResult.gsc-result,
.gsc-results .gsc-imageResult {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-webResult.gsc-result:hover,
.gsc-imageResult:hover {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gs-webResult.gs-result a.gs-title:link,
.gs-webResult.gs-result a.gs-title:link b,
.gs-imageResult a.gs-title:link,
.gs-imageResult a.gs-title:link b {
color: #1155CC;
}
.gs-webResult.gs-result a.gs-title:visited,
.gs-webResult.gs-result a.gs-title:visited b,
.gs-imageResult a.gs-title:visited,
.gs-imageResult a.gs-title:visited b {
color: #1155CC;
}
.gs-webResult.gs-result a.gs-title:hover,
.gs-webResult.gs-result a.gs-title:hover b,
.gs-imageResult a.gs-title:hover,
.gs-imageResult a.gs-title:hover b {
color: #1155CC;
}
.gs-webResult.gs-result a.gs-title:active,
.gs-webResult.gs-result a.gs-title:active b,
.gs-imageResult a.gs-title:active,
.gs-imageResult a.gs-title:active b {
color: #1155CC;
}
.gsc-cursor-page {
color: #1155CC;
}
a.gsc-trailing-more-results:link {
color: #1155CC;
}
.gs-webResult .gs-snippet,
.gs-imageResult .gs-snippet,
.gs-fileFormatType {
color: #333333;
}
.gs-webResult div.gs-visibleUrl,
.gs-imageResult div.gs-visibleUrl {
color: #009933;
}
.gs-webResult div.gs-visibleUrl-short {
color: #009933;
}
.gs-webResult div.gs-visibleUrl-short {
display: none;
}
.gs-webResult div.gs-visibleUrl-long {
display: block;
}
.gs-promotion div.gs-visibleUrl-short {
display: none;
}
.gs-promotion div.gs-visibleUrl-long {
display: block;
}
.gsc-cursor-box {
border-color: #FFFFFF;
}
.gsc-results .gsc-cursor-box .gsc-cursor-page {
border-color: #CCCCCC;
background-color: #FFFFFF;
color: #1155CC;
}
.gsc-results .gsc-cursor-box .gsc-cursor-current-page {
border-color: #CCCCCC;
background-color: #FFFFFF;
color: #1155CC;
}
.gsc-webResult.gsc-result.gsc-promotion {
border-color: #F6F6F6;
background-color: #F6F6F6;
}
.gsc-completion-title {
color: #1155CC;
}
.gsc-completion-snippet {
color: #333333;
}
.gs-promotion a.gs-title:link,
.gs-promotion a.gs-title:link *,
.gs-promotion .gs-snippet a:link {
color: #1155CC;
}
.gs-promotion a.gs-title:visited,
.gs-promotion a.gs-title:visited *,
.gs-promotion .gs-snippet a:visited {
color: #1155CC;
}
.gs-promotion a.gs-title:hover,
.gs-promotion a.gs-title:hover *,
.gs-promotion .gs-snippet a:hover {
color: #1155CC;
}
.gs-promotion a.gs-title:active,
.gs-promotion a.gs-title:active *,
.gs-promotion .gs-snippet a:active {
color: #1155CC;
}
.gs-promotion .gs-snippet,
.gs-promotion .gs-title .gs-promotion-title-right,
.gs-promotion .gs-title .gs-promotion-title-right * {
color: #333333;
}
.gs-promotion .gs-visibleUrl,
.gs-promotion .gs-visibleUrl-short {
color: #009933;
}
.gsc-input input.gsc-input {
background: none repeat scroll 0% 0% white !important;
}</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-moz-user-select:none;white-space:nowrap}.gsst_e{opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-moz-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-moz-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gscsep_a{display:none}.gsq_a{padding:0}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gsfe_a{border:1px solid #b9b9b9;border-top-color:#a0a0a0;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);}.gsfe_b{border:1px solid #4d90fe;outline:none;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);}.gssb_a{padding:0 9px}.gsib_a{padding-right:8px;padding-left:8px}.gsst_a{padding-top:3px}.gssb_e{border:0}.gssb_l{margin:5px 0}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style><style type="text/css">.atlwdg-blanket {background: black;height: 100%;left: 0;opacity: .5;position: fixed;top: 0;width: 100%;z-index: 1000000;}.atlwdg-popup {background: white;border: 1px solid #666;position: fixed;top: 50%;left: 50%;z-index: 10000011;}.atlwdg-popup.atlwdg-box-shadow {-moz-box-shadow: 10px 10px 20px rgba(0,0,0,0.5);-webkit-box-shadow: 10px 10px 20px rgba(0,0,0,0.5);box-shadow: 10px 10px 20px rgba(0,0,0,0.5);background-color: white;}.atlwdg-hidden {display: none;}.atlwdg-trigger {position: fixed;background: #013466;padding: 5px;border: 2px solid white;border-top: none;font-weight: bold;color: white !important;display: block;white-space: nowrap;text-decoration: none !important;font-family: arial, FreeSans, Helvetica, sans-serif;font-size: 12px;box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);-webkit-box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);-moz-box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);border-radius: 0 0 5px 5px;-moz-border-radius: 0 0 5px 5px;}.atlwdg-trigger.atlwdg-TOP {left: 45%;top: 0;}.atlwdg-trigger.atlwdg-RIGHT {left: 100%;top: 40%;-webkit-transform-origin: top left;-webkit-transform: rotate(90deg);-moz-transform: rotate(90deg);-moz-transform-origin: top left;-ms-transform: rotate(90deg);-ms-transform-origin: top left;}.atlwdg-trigger.atlwdg-SUBTLE {right: 0;bottom: 0;border: 1px solid #ccc;border-bottom: none;border-right: none;background-color: #f5f5f5;color: #444 !important;font-size: 11px;padding: 6px;box-shadow: -1px -1px 2px rgba(0, 0, 0, 0.5);border-radius: 2px 0 0 0;}.atlwdg-loading {position: absolute;top: 220px;left: 295px;}@media print {.atlwdg-trigger { display: none; }}</style><script src="Mongoid%20Tutorial%20%285.0.0%29_files/roundtrip.js" type="text/javascript" async="true"></script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/3L5E5MU7GBC3NMYB75WIRR" type="text/javascript" async="true"></script><div style="width: 1px; height: 1px; display: inline; position: absolute;"><img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_008.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_007.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_003.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_005.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_006.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_004.gif" height="1" width="1">
<img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/out_002.gif" height="1" width="1">
<img alt="" style="display:none" src="Mongoid%20Tutorial%20%285.0.0%29_files/tr.gif" height="1" width="1"><img style="border-style:none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/a.gif" height="1" width="1">
<img src="Mongoid%20Tutorial%20%285.0.0%29_files/seg.gif" height="1" width="1">
</div></head>
<body>
  <!-- Google Tag Manager -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-JQHP"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
     {'gtm.start': new Date().getTime(),event:'gtm.js'}
   );var f=d.getElementsByTagName(s)[0],
   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
   '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
   })(window,document,'script','dataLayer','GTM-JQHP');</script>
  <!-- End Google Tag Manager -->
    <header id="header-db" class="row" role="navigation">
      <div class="header-content">
        <a class="fa fa-bars expand-toc-icon pull-left" href="#"></a>
           <div class="logo pull-left">
             <a href="https://www.mongodb.org/">
               <img src="Mongoid%20Tutorial%20%285.0.0%29_files/logo-mongodb-header.png" ,="" alt="MongoDB.org">
             </a>
           </div>
        
        <div>
          <div class="search-db narrow pull-right"><div id="___gcse_0"><div dir="ltr" class="gsc-control-searchbox-only gsc-control-searchbox-only-en"><form accept-charset="utf-8" class="gsc-search-box gsc-search-box-tools"><table class="gsc-search-box" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsc-input"><div id="gsc-iw-id1" class="gsc-input-box "><table class="gstl_50 " id="gs_id50" style="width: 100%; padding: 0px;" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsib_a" id="gs_tti50"><input placeholder="Search mongodb.org" spellcheck="false" dir="ltr" id="gsc-i-id1" style="width: 100%; padding: 0px; border: medium none; margin: 0px; height: auto; outline: medium none;" title="search" name="search" class="gsc-input" size="10" autocomplete="off" type="text"></td><td class="gsib_b"><div dir="ltr" id="gs_st50" class="gsst_b"><a style="display: none;" href="javascript:void(0)" class="gsst_a"><span id="gs_cb50" class="gscb_a">×</span></a></div></td></tr></tbody></table></div><input id="bgresponse" name="bgresponse" type="hidden"></td><td class="gsc-search-button"><input title="search" class="gsc-search-button gsc-search-button-v2" src="Mongoid%20Tutorial%20%285.0.0%29_files/search_box_icon.png" type="image"></td><td class="gsc-clear-button"><div title="clear results" class="gsc-clear-button">&nbsp;</div></td></tr></tbody></table><table class="gsc-branding" cellpadding="0" cellspacing="0"><tbody><tr style="display: none;"><td class="gsc-branding-user-defined"></td><td class="gsc-branding-text"><div class="gsc-branding-text">powered by</div></td><td class="gsc-branding-img"><img class="gsc-branding-img" src="Mongoid%20Tutorial%20%285.0.0%29_files/small-logo.png"></td></tr></tbody></table></form></div></div></div>
          
          <div class="nav-items pull-right">
   <a href="https://docs.mongodb.org/manual/">Manual</a>
   <a href="https://university.mongodb.com/">Learn</a>
   <a href="http://www.mongodb.org/downloads">Downloads</a>
   <a href="http://www.mongodb.org/get-involved">Community</a>
   <a href="http://blog.mongodb.org/">Blog</a>

          </div>
        </div>
      </div>
    </header>

  <aside class="sidebar">
       
  <div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper" style=""><h3>
  <a href="http://docs.mongodb.org/ecosystem/">MongoDB Ecosystem</a>
</h3>

<ul style="display: block;" class="current">
<li class="toctree-l1 current"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/">MongoDB Drivers</a><ul style="display: block;" class="current">
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/c/"><span class="expand-icon"></span>C Driver</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/cpp/"><span class="expand-icon"></span>C++ Driver</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/csharp/"><span class="expand-icon"></span>C# and .NET Driver</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/java/"><span class="expand-icon"></span>Java Driver</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/node-js/"><span class="expand-icon"></span>Node.js Driver</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/perl/"><span class="expand-icon"></span>Perl Driver</a><ul style="display: none;">
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/perl-internals/"><span class="expand-icon"></span>Contribute to the Perl Driver</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/php/"><span class="expand-icon"></span>PHP Driver</a><ul style="display: none;">
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/php-libraries/"><span class="expand-icon"></span>PHP Libraries, Frameworks and Tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/python/"><span class="expand-icon"></span>Python Driver</a><ul style="display: none;">
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/write-a-tumblelog-application-with-flask-mongoengine/"><span class="expand-icon"></span>Write a Tumblelog Application with Flask and MongoEngine</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/ruby/"><span class="expand-icon"></span>Ruby Driver</a><ul style="display: block;" class="current">
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/ruby-resources/"><span class="expand-icon"></span>Ruby External Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/ruby-driver-tutorial/"><span class="expand-icon"></span>Ruby Driver Tutorial (2.0.0)</a></li>
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/ruby-bson-tutorial/"><span class="expand-icon"></span>Ruby BSON Tutorial (3.0.0)</a></li>
<li class="toctree-l3 current selected-item"><a class="current reference internal" href=""><span class="expand-icon"></span>Mongoid Tutorial (5.0.0)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/scala/"><span class="expand-icon"></span>Scala Driver</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/community-supported-drivers-toc/"><span class="expand-icon"></span>Community Supported Drivers</a><ul style="display: none;">
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/go/"><span class="expand-icon"></span>Go Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/erlang/"><span class="expand-icon"></span>Erlang Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/community-supported-drivers/"><span class="expand-icon"></span>Community Supported Drivers Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/syntax-table/"><span class="expand-icon"></span>Driver Syntax Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/drivers/driver-compatibility-reference/"><span class="expand-icon"></span>Driver Compatibility</a><ul style="display: none;" class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/">MongoDB Integration and Tools</a><ul style="display: none;">
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/hadoop/"><span class="expand-icon"></span>MongoDB Connector for Hadoop</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/getting-started-with-hadoop/"><span class="expand-icon"></span>Getting Started with Hadoop</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/hadoop/"><span class="expand-icon"></span>Hadoop and MongoDB Use Cases</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/configure-red-hat-enterprise-linux-identity-management/"><span class="expand-icon"></span>Configure Red Hat Enterprise Linux Identity Management with MongoDB</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/manage-red-hat-enterprise-linux-identity-management/"><span class="expand-icon"></span>Operational Procedures using Red Hat Enterprise Linux Identity Management</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/applications/"><span class="expand-icon"></span>MongoDB-Based Applications</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/administration-interfaces/"><span class="expand-icon"></span>Admin UIs</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/http-interfaces/"><span class="expand-icon"></span>HTTP Interface</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/munin/"><span class="expand-icon"></span>Munin Configuration Examples</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tools/wireshark/"><span class="expand-icon"></span>Wireshark Support for MongoDB Protocol</a><ul style="display: none;" class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/">Platforms</a><ul style="display: none;">
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/amazon-ec2/"><span class="expand-icon"></span>Amazon EC2</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/backup-and-restore-mongodb-on-amazon-ec2/"><span class="expand-icon"></span>EC2 Backup and Restore</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/digitalocean/"><span class="expand-icon"></span>DigitalOcean</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/dotcloud/"><span class="expand-icon"></span>dotCloud</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/tutorial/joyent-cloud/"><span class="expand-icon"></span>Joyent Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/modulus/"><span class="expand-icon"></span>Modulus</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/rackspace-cloud/"><span class="expand-icon"></span>Rackspace Cloud</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/red-hat-openshift/"><span class="expand-icon"></span>Red Hat OpenShift</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/vmware-cloud-foundry/"><span class="expand-icon"></span>VMware Cloud Foundry</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/windows-azure/"><span class="expand-icon"></span>Microsoft Azure</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/platforms/windows/"><span class="expand-icon"></span>Windows Quick Links and Reference Center</a><ul style="display: none;" class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/">Use Cases</a><ul style="display: none;">
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/storing-log-data/"><span class="expand-icon"></span>Storing Log Data</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/pre-aggregated-reports/"><span class="expand-icon"></span>Pre-Aggregated Reports</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/hierarchical-aggregation/"><span class="expand-icon"></span>Hierarchical Aggregation</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/product-catalog/"><span class="expand-icon"></span>Product Catalog</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/inventory-management/"><span class="expand-icon"></span>Inventory Management</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/category-hierarchy/"><span class="expand-icon"></span>Category Hierarchy</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/metadata-and-asset-management/"><span class="expand-icon"></span>Metadata and Asset Management</a><ul style="display: none;" class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/ecosystem/use-cases/storing-comments/"><span class="expand-icon"></span>Storing Comments</a><ul style="display: none;" class="simple">
</ul>
</li>
</ul>
</li>
</ul>


<div class="nav-footer">
  <a href="http://docs.mongodb.org/ecosystem/contents/">Contents</a>
</div>

    </div>
  </div>
    
  </aside>
  <div class="option-popup closed">
    <div class="option-header">
      <i class="fa fa-gear"></i>
      <span>OPTIONS</span>
      <i class="fa fa-angle-up pull-right"></i>
    </div>
    <div class="option-body">
      <ul>
         
           
        
           <!-- format selector -->
           <li>
             <label>Formats</label>
             <ul class="formats-list">
                   <li><a href="http://docs.mongodb.org/ecosystem/single" target="_blank">HTML</a></li><li><a href="http://docs.mongodb.org/ecosystem/MongoDB-Ecosystem-guide.pdf" target="_blank" rel="nofollow">PDF</a></li><li><a href="http://docs.mongodb.org/ecosystem/mongodb-ecosystem.epub" target="_blank" rel="nofollow">EPUB</a></li>
             </ul>
           </li>
        
        <!-- contribute -->
        <li>
          <label>Contribute</label>
          <ul class="contribute-list">
            <li><a class="jira-link jirafeedback" href="https://jira.mongodb.org/secure/CreateIssueDetails%21init.jspa?pid=10380&amp;issuetype=4&amp;priority=4&amp;summary=Comment+on%3a+%22tutorial/ruby-mongoid-tutorial%2Etxt%22" target="_blank" title="Report a problem with tutorial/ruby-mongoid-tutorial.txt on Jira">Report a Problem</a></li>
               <li><a class="edit-link" href="https://github.com/mongodb/docs-ecosystem/blob/master/source/tutorial/ruby-mongoid-tutorial.txt" target="_blank" title="Edit tutorial/ruby-mongoid-tutorial.txt on GitHub">
    
      <span>Edit on Github</span>
    
  </a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
  <div class="content">
    <div class="main-column pull-left">

      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body">
                   <a class="edit-link" href="https://github.com/mongodb/docs-ecosystem/blob/master/source/tutorial/ruby-mongoid-tutorial.txt" target="_blank" title="Edit tutorial/ruby-mongoid-tutorial.txt on GitHub">
    
      <span class="icon-edit"></span>
    
  </a>
                
                
   <div class="bc">
     
       <ul>
          <li><a href="http://docs.mongodb.org/ecosystem/drivers/">MongoDB Drivers</a><span class="bcpoint"> &gt; </span></li>
          
          <li><a href="http://docs.mongodb.org/ecosystem/drivers/ruby/">Ruby MongoDB Driver</a><span class="bcpoint"> &gt; </span></li>
          <li>Mongoid Tutorial (5.0.0)</li> 
      </ul>
    
  </div>
                
                  <div class="section" id="mongoid-tutorial-5-0-0">
<span id="ruby-mongoid-tutorial"></span><h1>Mongoid Tutorial (5.0.0)<a class="headerlink" href="#mongoid-tutorial-5-0-0" title="Permalink to this headline">¶</a></h1>
<p>This tutorial discusses using the object document mapper Mongoid.</p>
<p><strong>Looking for the documentation for Mongoid 3 and 4? It is located</strong> <a class="reference external" href="http://mongoid.github.io/">here</a>.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installing-the-gem">
<h3>Installing The Gem<a class="headerlink" href="#installing-the-gem" title="Permalink to this headline">¶</a></h3>
<p>Mongoid is bundled as a gem, and is hosted on <a class="reference external" href="http://rubygems.org/">Rubygems</a>.
It can be installed manually or with bundler.</p>
<p>To install the gem manually:</p>
<div class="highlight-sh"><div class="highlight"><pre>gem install mongoid
</pre></div>
</div>
<p>To install the gem with bundler, include the following in your Gemfile:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'mongoid'</span><span class="p">,</span> <span class="s1">'~&gt; 5.0.0.beta'</span>
</pre></div>
</div>
</div>
<div class="section" id="compatibility">
<h3>Compatibility<a class="headerlink" href="#compatibility" title="Permalink to this headline">¶</a></h3>
<p>Note the following compatibility matrix to determine if Mongoid is
supported on your runtime and server.</p>
<table class="docutils" border="1">
<colgroup>
<col width="24%">
<col width="25%">
<col width="25%">
<col width="25%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Ruby Version</th>
<th class="head">2.4.x</th>
<th class="head">2.6.x</th>
<th class="head">3.0.x</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>MRI 1.8.x</td>
<td>No</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="row-odd"><td>MRI 1.9.x</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>MRI 2.0.x</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>MRI 2.1.x</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>MRI 2.2.x</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>JRuby 1.7.x</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>Mongoid configuration can be done through a <tt class="docutils literal"><span class="pre">mongoid.yml</span></tt> that specifies your
options and clients. The simplest configuration is as follows, which sets the default
client to “localhost:27017” and provides a single database in that client named “mongoid”.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">clients</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mongoid</span>
      <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">localhost:27017</span>
</pre></div>
</div>
<div class="section" id="rails-applications">
<h4>Rails Applications<a class="headerlink" href="#rails-applications" title="Permalink to this headline">¶</a></h4>
<p>You can generate a config file by executing the generator and then editing
<tt class="docutils literal"><span class="pre">myapp/config/mongoid.yml</span></tt> to your heart’s desire. Mongoid will then handle
everything else from there.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rails g mongoid:config
</pre></div>
</div>
<p>When Mongoid loads its configuration, it chooses the environment to used based
on the following order:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">Rails.env</span></tt> if using Rails.</li>
<li><tt class="docutils literal"><span class="pre">Sinatra::Base.environment</span></tt> if using Sinatra.</li>
<li><tt class="docutils literal"><span class="pre">RACK_ENV</span></tt> environment variable.</li>
<li><tt class="docutils literal"><span class="pre">MONGOID_ENV</span></tt> environment variable.</li>
</ul>
<p>If you are not using any rack based application and want to override the
environment programatically, you can pass a second paramter to <tt class="docutils literal"><span class="pre">load!</span></tt> and
Mongoid will use that.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Mongoid</span><span class="o">.</span><span class="n">load!</span><span class="p">(</span><span class="s2">"path/to/your/mongoid.yml"</span><span class="p">,</span> <span class="ss">:production</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="anatomy-of-a-mongoid-config">
<h4>Anatomy of a Mongoid Config<a class="headerlink" href="#anatomy-of-a-mongoid-config" title="Permalink to this headline">¶</a></h4>
<p>Let’s have a look at a full-blown <tt class="docutils literal"><span class="pre">mongoid.yml</span></tt> and explain the full power
of what Mongoid can do. The following configuration has its explanation in the
comments above each key.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
  <span class="c1"># Configure available database clients. (required)</span>
  <span class="l-Scalar-Plain">clients</span><span class="p-Indicator">:</span>
    <span class="c1"># Defines the default client. (required)</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
      <span class="c1"># Defines the name of the default database that Mongoid can connect to.</span>
      <span class="c1"># (required).</span>
      <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my_db</span>
      <span class="c1"># Provides the hosts the default client can connect to. Must be an array</span>
      <span class="c1"># of host:port pairs. (required)</span>
      <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">myhost1.mydomain.com:27017</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">myhost2.mydomain.com:27017</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">myhost3.mydomain.com:27017</span>
      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
        <span class="c1"># Change the default write concern. (default = { w: 1 })</span>
        <span class="l-Scalar-Plain">write</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">w</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>

        <span class="c1"># Change the default read preference. Valid options for mode are: :secondary,</span>
        <span class="c1"># :secondary_preferred, :primary, :primary_preferred, :nearest</span>
        <span class="c1"># (default: primary)</span>
        <span class="l-Scalar-Plain">read</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">:secondary_preferred</span>

        <span class="c1"># The name of the user for authentication.</span>
        <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="s">'user'</span>

        <span class="c1"># The password of the user for authentication.</span>
        <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">'password'</span>

        <span class="c1"># The user's database roles.</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="s">'dbOwner'</span>

        <span class="c1"># Change the default authentication mechanism. Valid options are: :scram,</span>
        <span class="c1"># :mongodb_cr, :mongodb_x509, and :plain. (default on 3.0 is :scram, default</span>
        <span class="c1"># on 2.4 and 2.6 is :plain)</span>
        <span class="l-Scalar-Plain">auth_mech</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">:scram</span>

        <span class="c1"># The database or source to authenticate the user against. (default: admin)</span>
        <span class="l-Scalar-Plain">auth_source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">admin</span>

        <span class="c1"># Force a the driver cluster to behave in a certain manner instead of auto-</span>
        <span class="c1"># discovering. Can be one of: :direct, :replica_set, :sharded. Set to :direct</span>
        <span class="c1"># when connecting to hidden members of a replica set.</span>
        <span class="l-Scalar-Plain">connect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">:direct</span>

        <span class="c1"># Changes the default time in seconds the server monitors refresh their status</span>
        <span class="c1"># via ismaster commands. (default: 10)</span>
        <span class="l-Scalar-Plain">heartbeat_frequency</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

        <span class="c1"># The time in seconds for selecting servers for a near read preference. (default: 5)</span>
        <span class="l-Scalar-Plain">local_threshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>

        <span class="c1"># The timeout in seconds for selecting a server for an operation. (default: 30)</span>
        <span class="l-Scalar-Plain">server_selection_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>

        <span class="c1"># The maximum number of connections in the connection pool. (default: 5)</span>
        <span class="l-Scalar-Plain">max_pool_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>

        <span class="c1"># The minimum number of connections in the connection pool. (default: 1)</span>
        <span class="l-Scalar-Plain">min_pool_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>

        <span class="c1"># The time to wait, in seconds, in the connection pool for a connection</span>
        <span class="c1"># to be checked in before timing out. (default: 5)</span>
        <span class="l-Scalar-Plain">wait_queue_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>

        <span class="c1"># The time to wait to establish a connection before timing out, in seconds.</span>
        <span class="c1"># (default: 5)</span>
        <span class="l-Scalar-Plain">connect_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>

        <span class="c1"># The timeout to wait to execute operations on a socket before raising an error.</span>
        <span class="c1"># (default: 5)</span>
        <span class="l-Scalar-Plain">socket_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>

        <span class="c1"># The name of the replica set to connect to. Servers provided as seeds that do</span>
        <span class="c1"># not belong to this replica set will be ignored.</span>
        <span class="l-Scalar-Plain">replica_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my_replica_set</span>

        <span class="c1"># Whether to connect to the servers via ssl. (default: false)</span>
        <span class="l-Scalar-Plain">ssl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>

        <span class="c1"># The certificate file used to identify the connection against MongoDB.</span>
        <span class="l-Scalar-Plain">ssl_cert</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/my.cert</span>

        <span class="c1"># The private keyfile used to identify the connection against MongoDB.</span>
        <span class="c1"># Note that even if the key is stored in the same file as the certificate,</span>
        <span class="c1"># both need to be explicitly specified.</span>
        <span class="l-Scalar-Plain">ssl_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/my.key</span>

        <span class="c1"># A passphrase for the private key.</span>
        <span class="l-Scalar-Plain">ssl_key_pass_phrase</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">password</span>

        <span class="c1"># Whether or not to do peer certification validation. (default: false)</span>
        <span class="l-Scalar-Plain">ssl_verify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>

        <span class="c1"># The file containing a set of concatenated certification authority certifications</span>
        <span class="c1"># used to validate certs passed from the other end of the connection.</span>
        <span class="l-Scalar-Plain">ssl_ca_cert</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/ca.cert</span>

  <span class="c1"># Configure Mongoid specific options. (optional)</span>
  <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
    <span class="c1"># Includes the root model name in json serialization. (default: false)</span>
    <span class="l-Scalar-Plain">include_root_in_json</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>

    <span class="c1"># Include the _type field in serialization. (default: false)</span>
    <span class="l-Scalar-Plain">include_type_for_serialization</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>

    <span class="c1"># Preload all models in development, needed when models use</span>
    <span class="c1"># inheritance. (default: false)</span>
    <span class="l-Scalar-Plain">preload_models</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>

    <span class="c1"># Raise an error when performing a #find and the document is not found.</span>
    <span class="c1"># (default: true)</span>
    <span class="l-Scalar-Plain">raise_not_found_error</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>

    <span class="c1"># Raise an error when defining a scope with the same name as an</span>
    <span class="c1"># existing method. (default: false)</span>
    <span class="l-Scalar-Plain">scope_overwrite_exception</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>

    <span class="c1"># Use Active Support's time zone in conversions. (default: true)</span>
    <span class="l-Scalar-Plain">use_activesupport_time_zone</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>

    <span class="c1"># Ensure all times are UTC in the app side. (default: false)</span>
    <span class="l-Scalar-Plain">use_utc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</pre></div>
</div>
</div>
<div class="section" id="logging">
<h4>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h4>
<p>Changing logging options is done simply by telling Mongoid or the driver’s logger to have
a different level. Logging level is <tt class="docutils literal"><span class="pre">DEBUG</span></tt> by default.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Mongoid</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="ss">Logger</span><span class="p">:</span><span class="ss">:DEBUG</span>
<span class="no">Mongo</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="ss">Logger</span><span class="p">:</span><span class="ss">:DEBUG</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="documents">
<h2>Documents<a class="headerlink" href="#documents" title="Permalink to this headline">¶</a></h2>
<p>Documents are the core objects in Mongoid and any object that is to be persisted to the
database must include <tt class="docutils literal"><span class="pre">Mongoid::Document</span></tt>. The representation of a Document in MongoDB
is a BSON object that is very similar to a Ruby hash or JSON object. Documents can be stored
in their own collections in the database, or can be embedded in other Documents n levels deep.</p>
<div class="section" id="storage">
<h3>Storage<a class="headerlink" href="#storage" title="Permalink to this headline">¶</a></h3>
<p>Mongoid by default stores documents in a collection that is the pluralized form of the class name.
For the following <tt class="docutils literal"><span class="pre">Person</span></tt> class, the collection the document would get stored in would be named <tt class="docutils literal"><span class="pre">people</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Model class names cannot end with “s”, because it will be considered as the pluralized form of
the word. For example “Status” would be considered as the plural form of “Statu”,
which will cause a few known problems.</p>
<p>This is a limitation of the <tt class="docutils literal"><span class="pre">ActiveSupport::Inflector#classify</span></tt> which Mongoid uses to convert
from filenames and collection names to class names. You can overcome this by specifying a custom
inflection rule for your model class. For example, the following code will take care of the model
named <tt class="docutils literal"><span class="pre">Status</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Inflector</span><span class="o">.</span><span class="n">inflections</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
  <span class="n">inflect</span><span class="o">.</span><span class="n">singular</span><span class="p">(</span><span class="s2">"status"</span><span class="p">,</span> <span class="s2">"status"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The collection for the model’s documents can be changed at the class level if you would like
them persisted elsewhere. You can also change the database and session the model gets persisted
in from the defaults.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">store_in</span> <span class="ss">collection</span><span class="p">:</span> <span class="s2">"citizens"</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s2">"other"</span><span class="p">,</span> <span class="ss">client</span><span class="p">:</span> <span class="s2">"secondary"</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">store_in</span></tt> macro can also take lambdas - a common case for this is multi-tenant applications.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">store_in</span> <span class="ss">database</span><span class="p">:</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:database</span><span class="o">]</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When a document is stored in the database the ruby object will get serialized into BSON
and have a structure like so:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">),</span>
  <span class="s2">"title"</span> <span class="p">:</span> <span class="s2">"Sir"</span><span class="p">,</span>
  <span class="s2">"name"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7ff"</span><span class="p">),</span>
    <span class="s2">"first_name"</span> <span class="p">:</span> <span class="s2">"Durran"</span>
  <span class="p">},</span>
  <span class="s2">"addresses"</span> <span class="p">:</span> <span class="o">[</span>
    <span class="p">{</span>
      <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e0"</span><span class="p">),</span>
      <span class="s2">"city"</span> <span class="p">:</span> <span class="s2">"Berlin"</span><span class="p">,</span>
      <span class="s2">"country"</span> <span class="p">:</span> <span class="s2">"Deutschland"</span>
    <span class="p">}</span>
  <span class="o">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fields">
<h3>Fields<a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h3>
<p>Even though MongoDB is a schemaless database, most uses will be with web applications where
form parameters always come to the server as strings. Mongoid provides an easy mechanism for
transforming these strings into their appropriate types through the definition of fields
in a <tt class="docutils literal"><span class="pre">Mongoid::Document</span></tt>.</p>
<p>Consider a simple class for modeling a person in an application. A person may have a first name,
last name, and middle name. We can define these attributes on a person by using the fields macro.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:middle_name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Below is a list of valid types for fields.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">Array</span></tt></li>
<li><tt class="docutils literal"><span class="pre">BigDecimal</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Boolean</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Date</span></tt></li>
<li><tt class="docutils literal"><span class="pre">DateTime</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Float</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Hash</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Integer</span></tt></li>
<li><tt class="docutils literal"><span class="pre">BSON::ObjectId</span></tt></li>
<li><tt class="docutils literal"><span class="pre">BSON::Binary</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Range</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Regexp</span></tt></li>
<li><tt class="docutils literal"><span class="pre">String</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Symbol</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Time</span></tt></li>
<li><tt class="docutils literal"><span class="pre">TimeWithZone</span></tt></li>
</ul>
<p>If you decide not to specify the type of field with the definition, Mongoid will treat
it as an object and not try to typecast it when sending the values to the database.
This can be advantageous in 2 places, since the lack of attempted conversion will yield
a slight performance gain. However some fields are not supported if not defined as fields.
A note of thumb for what fields you can use are:</p>
<ul class="simple">
<li>You’re not using a web front end and values are already properly cast.</li>
<li>All of your fields are strings.</li>
</ul>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:first_name</span>
  <span class="n">field</span> <span class="ss">:middle_name</span>
  <span class="n">field</span> <span class="ss">:last_name</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Types that are not supported as dynamic attributes since they cannot be cast are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">BigDecimal</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Date</span></tt></li>
<li><tt class="docutils literal"><span class="pre">DateTime</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Range</span></tt></li>
</ul>
<div class="section" id="accessing-field-values">
<h4>Accessing Field Values<a class="headerlink" href="#accessing-field-values" title="Permalink to this headline">¶</a></h4>
<p>When a field is defined, Mongoid provides several different ways of accessing the field.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Get the value of the first_name field</span>
<span class="n">person</span><span class="o">.</span><span class="n">first_name</span>
<span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span>
<span class="n">person</span><span class="o">.</span><span class="n">read_attribute</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span>


<span class="c1"># Set the value for the first_name field</span>
<span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Jean"</span>
<span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Jean"</span>
<span class="n">person</span><span class="o">.</span><span class="n">write_attribute</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="s2">"Jean"</span><span class="p">)</span>
</pre></div>
</div>
<p>If you have defined custom getter/setter, those will be used when using the dot notation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>

  <span class="n">field</span> <span class="ss">:first_name</span>

  <span class="c1"># custom getter</span>
  <span class="k">def</span> <span class="nf">first_name</span>
    <span class="s2">"My name is Johnny"</span>
  <span class="k">end</span>

  <span class="c1"># custom setter</span>
  <span class="k">def</span> <span class="nf">first_name</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">p</span> <span class="s1">'Setting.. '</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">value</span>
    <span class="nb">p</span> <span class="s1">'.. done!'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Like this:</span>
<span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'John'</span>
<span class="c1"># Setting..</span>
<span class="c1"># .. done!</span>

<span class="n">person</span><span class="o">.</span><span class="n">first_name</span>                  <span class="c1"># My name is Johnny</span>
<span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span>                <span class="c1"># John</span>
<span class="n">person</span><span class="o">.</span><span class="n">read_attribute</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span> <span class="c1"># John</span>
</pre></div>
</div>
<p>In cases where you want to set multiple field values at once, there are a few different ways
of handling this as well.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Get the field values as a hash.</span>
<span class="n">person</span><span class="o">.</span><span class="n">attributes</span>

<span class="c1"># Set the field values in the document.</span>
<span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s2">"Jean-Baptiste"</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">:</span> <span class="s2">"Emmanuel"</span><span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Jean-Baptiste"</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">:</span> <span class="s2">"Emmanuel"</span> <span class="p">}</span>
<span class="n">person</span><span class="o">.</span><span class="n">write_attributes</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Jean-Baptiste"</span><span class="p">,</span>
  <span class="n">middle_name</span><span class="p">:</span> <span class="s2">"Emmanuel"</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="hash-fields">
<h4>Hash Fields<a class="headerlink" href="#hash-fields" title="Permalink to this headline">¶</a></h4>
<p>When using a field of type Hash, be wary of adhering to the
<a class="reference external" href="http://docs.mongodb.org/manual/reference/limits/#naming-restrictions">legal key names for mongoDB</a>,
or else the values will not store properly.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:first_name</span>
  <span class="n">field</span> <span class="ss">:url</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span>

  <span class="c1"># will update the fields properly and save the values</span>
  <span class="k">def</span> <span class="nf">set_vals</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Daniel'</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'home_page'</span> <span class="o">=&gt;</span> <span class="s1">'http://www.homepage.com'</span><span class="p">}</span>
    <span class="n">save</span>
  <span class="k">end</span>

  <span class="c1"># all data will fail to save due to the illegal hashkey</span>
  <span class="k">def</span> <span class="nf">set_vals_fail</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Daniel'</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'home.page'</span> <span class="o">=&gt;</span> <span class="s1">'http://www.homepage.com'</span><span class="p">}</span>
    <span class="n">save</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="defaults">
<h4>Defaults<a class="headerlink" href="#defaults" title="Permalink to this headline">¶</a></h4>
<p>You can tell a field in Mongoid to always have a default value if nothing has been provided.
Defaults are either static values or lambdas.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:blood_alcohol_level</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">40</span>
  <span class="n">field</span> <span class="ss">:last_drink</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="mi">10</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">ago</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Be wary that default values that are not defined as lambdas or procs are evaluated
at class load time, so the following 2 definitions are not equivalent.
(One would probably prefer the second, which is at document creation time.)</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">field</span> <span class="ss">:dob</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
<span class="n">field</span> <span class="ss">:dob</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="p">}</span>
</pre></div>
</div>
<p>If you want to set a default with a dependency on the document’s state, self inside a lambda
or proc evaluates to the document instance.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">field</span> <span class="ss">:intoxicated_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">new_record?</span> <span class="p">?</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span> <span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="p">}</span>
</pre></div>
</div>
<p>When defining a default value as a proc, Mongoid will apply the default after all other
attributes are set. If you want this to happen before the other attributes, set <tt class="docutils literal"><span class="pre">pre_processed:</span> <span class="pre">true</span></tt>.</p>
</div>
<div class="section" id="aliasing-fields">
<h4>Aliasing Fields<a class="headerlink" href="#aliasing-fields" title="Permalink to this headline">¶</a></h4>
<p>One of the drawbacks of having a schemaless database is that MongoDB must store all field
information along with every document, meaning that it takes up a lot of storage space in RAM
and on disk. A common pattern to limit this is to alias fields to a small number of characters,
while keeping the domain in the application expressive. Mongoid allows you to do this and
reference the fields in the domain via their long names in getters, setters, and criteria while
performing the conversion for you.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:n</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Placebo"</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">attributes</span> <span class="c1">#=&gt; { "n" =&gt; "Placebo" }</span>

<span class="n">criteria</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Placebo"</span><span class="p">)</span>
<span class="n">criteria</span><span class="o">.</span><span class="n">selector</span> <span class="c1">#=&gt; { "n" =&gt; "Placebo" }</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-fields">
<h4>Custom Fields<a class="headerlink" href="#custom-fields" title="Permalink to this headline">¶</a></h4>
<p>You can define custom types in Mongoid and determine how they are serialized and deserialized.
You simply need to provide 3 methods on it for Mongoid to call to convert your object to and
from MongoDB friendly values.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Profile</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Point</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Point</span>

  <span class="kp">attr_reader</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">:y</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="vi">@x</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
  <span class="k">end</span>

  <span class="c1"># Converts an object of this instance into a database friendly value.</span>
  <span class="k">def</span> <span class="nf">mongoize</span>
    <span class="o">[</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">]</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>

    <span class="c1"># Get the object as it was stored in the database, and instantiate</span>
    <span class="c1"># this custom class from it.</span>
    <span class="k">def</span> <span class="nf">demongoize</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
      <span class="no">Point</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">object</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">object</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Takes any possible object and converts it to how it would be</span>
    <span class="c1"># stored in the database.</span>
    <span class="k">def</span> <span class="nf">mongoize</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">object</span>
      <span class="k">when</span> <span class="no">Point</span> <span class="k">then</span> <span class="n">object</span><span class="o">.</span><span class="n">mongoize</span>
      <span class="k">when</span> <span class="no">Hash</span> <span class="k">then</span> <span class="no">Point</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">object</span><span class="o">[</span><span class="ss">:x</span><span class="o">]</span><span class="p">,</span> <span class="n">object</span><span class="o">[</span><span class="ss">:y</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">mongoize</span>
      <span class="k">else</span> <span class="n">object</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Converts the object that was supplied to a criteria and converts it</span>
    <span class="c1"># into a database friendly form.</span>
    <span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">object</span>
      <span class="k">when</span> <span class="no">Point</span> <span class="k">then</span> <span class="n">object</span><span class="o">.</span><span class="n">mongoize</span>
      <span class="k">else</span> <span class="n">object</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The instance method <tt class="docutils literal"><span class="pre">mongoize</span></tt> takes an instance of your object, and converts it
into how it will be stored in the database. In our example above, we want to store our
point object as an array in the form <tt class="docutils literal"><span class="pre">[</span> <span class="pre">x,</span> <span class="pre">y</span> <span class="pre">]</span></tt>.</p>
<p>The class method <tt class="docutils literal"><span class="pre">demongoize</span></tt> takes an object as how it was stored in the database,
and is responsible for instantiating an object of your custom type. In this case, we
take an array and instantiate a <tt class="docutils literal"><span class="pre">Point</span></tt> from it.</p>
<p>The class method <tt class="docutils literal"><span class="pre">mongoize</span></tt> takes an object that you would use to set on your model
from your application code, and create the object as it would be stored in the database.
This is for cases where you are not passing your model instances of your custom type in the setter:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">point</span> <span class="o">=</span> <span class="no">Point</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">venue</span> <span class="o">=</span> <span class="no">Venue</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">location</span><span class="p">:</span> <span class="n">point</span><span class="p">)</span> <span class="c1">#=&gt; This uses the mongoize instance method.</span>
<span class="n">venue</span> <span class="o">=</span> <span class="no">Venue</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">location</span><span class="p">:</span> <span class="o">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span> <span class="o">]</span><span class="p">)</span> <span class="c1">#=&gt; This uses the mongoize class method.</span>
</pre></div>
</div>
<p>The class method <tt class="docutils literal"><span class="pre">evolve</span></tt> takes an object, and determines how it is to be transformed
for use in criteria. For example we may want to write a query like so:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">point</span> <span class="o">=</span> <span class="no">Point</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="no">Venue</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">location</span><span class="p">:</span> <span class="n">point</span><span class="p">)</span>
</pre></div>
</div>
<p>Not that when accessing custom fields from the document, you will get a new instance
of that object with each call to the getter. This is because Mongoid is generating a new
object from the object from the raw attributes on each access.</p>
<p>We need the point object in the criteria to be transformed to a Mongo friendly value when
it is not as well, <tt class="docutils literal"><span class="pre">evolve</span></tt> is the method that takes care of this. We check if the passed
in object is a <tt class="docutils literal"><span class="pre">Point</span></tt> first, in case we also want to be able to pass in ordinary arrays instead.</p>
</div>
<div class="section" id="reserved-names">
<h4>Reserved Names<a class="headerlink" href="#reserved-names" title="Permalink to this headline">¶</a></h4>
<p>If you define a field on your document that conflicts with a reserved method name in Mongoid,
the configuration will raise an error. For a list of these you may look at
<tt class="docutils literal"><span class="pre">Mongoid.destructive_fields</span></tt>.</p>
</div>
<div class="section" id="custom-ids">
<h4>Custom Ids<a class="headerlink" href="#custom-ids" title="Permalink to this headline">¶</a></h4>
<p>For cases when you do not want to have <tt class="docutils literal"><span class="pre">BSON::ObjectId</span></tt> ids, you can override Mongoid’s
<tt class="docutils literal"><span class="pre">_id</span></tt> field and set them to whatever you like.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:_id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="nb">name</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dynamic-fields">
<h3>Dynamic Fields<a class="headerlink" href="#dynamic-fields" title="Permalink to this headline">¶</a></h3>
<p>By default Mongoid doesn’t supports dynamic fields. You can tell mongoid that you want
to add dynamic fields by including <tt class="docutils literal"><span class="pre">Mongoid::Attributes::Dynamic</span></tt> in model.
<tt class="docutils literal"><span class="pre">Mongoid::Attributes::Dynamic</span></tt> will allow attributes to get set and persisted on the
document even if a field was not defined for them. There is a slight ‘gotcha’ however when
dealing with dynamic attributes in that Mongoid is not completely lenient about the use of
<tt class="docutils literal"><span class="pre">method_missing</span></tt> and breaking the public interface of the Document class.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Attributes</span><span class="o">::</span><span class="no">Dynamic</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When dealing with dynamic attributes the following rules apply:</p>
<p>If the attribute exists in the document, Mongoid will provide you with your standard
getter and setter methods. For example, consider a person who has an attribute of
“gender” set on the document:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Set the person's gender to male.</span>
<span class="n">person</span><span class="o">[</span><span class="ss">:gender</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Male"</span>
<span class="n">person</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="s2">"Male"</span>

<span class="c1"># Get the person's gender.</span>
<span class="n">person</span><span class="o">.</span><span class="n">gender</span>
</pre></div>
</div>
<p>If the attribute does not already exist on the document, Mongoid will not provide you with
the getters and setters and will enforce normal <tt class="docutils literal"><span class="pre">method_missing</span></tt> behavior. In this case you
must use the other provided accessor methods:
(<tt class="docutils literal"><span class="pre">[]</span></tt> and <tt class="docutils literal"><span class="pre">[]=</span></tt>) or (<tt class="docutils literal"><span class="pre">read_attribute</span></tt> and <tt class="docutils literal"><span class="pre">write_attribute</span></tt>).</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Raise a NoMethodError if value isn't set.</span>
<span class="n">person</span><span class="o">.</span><span class="n">gender</span>
<span class="n">person</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="s2">"Male"</span>

<span class="c1"># Retrieve a dynamic field safely.</span>
<span class="n">person</span><span class="o">[</span><span class="ss">:gender</span><span class="o">]</span>
<span class="n">person</span><span class="o">.</span><span class="n">read_attribute</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span>

<span class="c1"># Write a dynamic field safely.</span>
<span class="n">person</span><span class="o">[</span><span class="ss">:gender</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Male"</span>
<span class="n">person</span><span class="o">.</span><span class="n">write_attribute</span><span class="p">(</span><span class="ss">:gender</span><span class="p">,</span> <span class="s2">"Male"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="localized-fields">
<h3>Localized Fields<a class="headerlink" href="#localized-fields" title="Permalink to this headline">¶</a></h3>
<p>Mongoid now supports localized fields without the need of any external gem.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">localize</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<p>By telling the field to <tt class="docutils literal"><span class="pre">localize</span></tt>, Mongoid will under the covers store the field
as a hash of locale/value pairs, but normal access to it will behave like a string.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">I18n</span><span class="o">.</span><span class="n">default_locale</span> <span class="o">=</span> <span class="ss">:en</span>
<span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">new</span>
<span class="n">product</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">"Marvelous!"</span>
<span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="ss">:de</span>
<span class="n">product</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">"Fantastisch!"</span>

<span class="n">product</span><span class="o">.</span><span class="n">attributes</span>
<span class="c1">#=&gt; { "description" =&gt; { "en" =&gt; "Marvelous!", "de" =&gt; "Fantastisch!" }</span>
</pre></div>
</div>
<p>You can get and set all the translations at once by using the corresponding <tt class="docutils literal"><span class="pre">_translations</span></tt> method.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">product</span><span class="o">.</span><span class="n">description_translations</span>
<span class="c1">#=&gt; { "en" =&gt; "Marvelous!", "de" =&gt; "Fantastisch!" }</span>
<span class="n">product</span><span class="o">.</span><span class="n">description_translations</span> <span class="o">=</span>
  <span class="p">{</span> <span class="s2">"en"</span> <span class="o">=&gt;</span> <span class="s2">"Marvelous!"</span><span class="p">,</span> <span class="s2">"de"</span> <span class="o">=&gt;</span> <span class="s2">"Wunderbar!"</span> <span class="p">}</span>
</pre></div>
</div>
<div class="section" id="fallbacks">
<h4>Fallbacks<a class="headerlink" href="#fallbacks" title="Permalink to this headline">¶</a></h4>
<p>When using fallbacks, Mongoid will automatically use them when a translation is not available.</p>
<p>For Rails applications, set the fallbacks configuration setting to true in your environment.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">fallbacks</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>
</div>
<p>For non-rails applications, you must include the fallbacks module straight to the I18n gem.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s2">"i18n/backend/fallbacks"</span>
<span class="ss">I18n</span><span class="p">:</span><span class="ss">:Backend</span><span class="o">::</span><span class="no">Simple</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="ss">I18n</span><span class="p">:</span><span class="ss">:Backend</span><span class="o">::</span><span class="no">Fallbacks</span><span class="p">)</span>
</pre></div>
</div>
<p>Then when the fallbacks are defined, if a translation is not present Mongoid will fallback
in order of the defined locales.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">I18n</span><span class="o">.</span><span class="n">default_locale</span> <span class="o">=</span> <span class="ss">:en</span>
<span class="no">I18n</span><span class="o">.</span><span class="n">fallbacks</span> <span class="o">=</span> <span class="kp">true</span>
<span class="o">::</span><span class="no">I18n</span><span class="o">.</span><span class="n">fallbacks</span><span class="o">[</span><span class="ss">:de</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="ss">:de</span><span class="p">,</span> <span class="ss">:en</span><span class="p">,</span> <span class="ss">:es</span> <span class="o">]</span>
<span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">new</span>
<span class="n">product</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">"Marvelous!"</span>
<span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="ss">:de</span>
<span class="n">product</span><span class="o">.</span><span class="n">description</span> <span class="c1">#=&gt; "Marvelous!"</span>
</pre></div>
</div>
</div>
<div class="section" id="querying">
<h4>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h4>
<p>When querying for localized fields using Mongoid’s criteria API, Mongoid will automatically
alter the criteria to match the current locale.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Match all prodcucts with Marvelous as the description. Locale is en.</span>
<span class="no">Product</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="s2">"Marvelous!"</span><span class="p">)</span>
<span class="c1"># The resulting MongoDB query filter: { "description.en" : "Marvelous!" }</span>
</pre></div>
</div>
</div>
<div class="section" id="indexing">
<h4>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h4>
<p>If you plan to be querying extensively on localized fields, you should index each of the
locales that you plan on searching on.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">localize</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">index</span> <span class="s2">"description.de"</span> <span class="o">=&gt;</span> <span class="mi">1</span>
  <span class="n">index</span> <span class="s2">"description.en"</span> <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dirty-tracking">
<h3>Dirty Tracking<a class="headerlink" href="#dirty-tracking" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supports tracking of changed or “dirty” fields with an API that mirrors that of
Active Model. If a defined field has been modified in a model the model will be marked as
dirty and some additional behavior comes into play.</p>
<div class="section" id="viewing-changes">
<h4>Viewing Changes<a class="headerlink" href="#viewing-changes" title="Permalink to this headline">¶</a></h4>
<p>There are various ways to view what has been altered on a model. Changes are recorded
from the time a document is instantiated, either as a new document or via loading from
the database up to the time it is saved. Any persistence operation clears the changes.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">first</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Alan Garner"</span>

<span class="c1"># Check to see if the document has changed.</span>
<span class="n">person</span><span class="o">.</span><span class="n">changed?</span> <span class="c1">#=&gt; true</span>

<span class="c1"># Get an array of the names of the changed fields.</span>
<span class="n">person</span><span class="o">.</span><span class="n">changed</span> <span class="c1">#=&gt; [ :name ]</span>

<span class="c1"># Get a hash of the old and changed values for each field.</span>
<span class="n">person</span><span class="o">.</span><span class="n">changes</span> <span class="c1">#=&gt; { "name" =&gt; [ "Alan Parsons", "Alan Garner" ] }</span>

<span class="c1"># Check if a specific field has changed.</span>
<span class="n">person</span><span class="o">.</span><span class="n">name_changed?</span> <span class="c1">#=&gt; true</span>

<span class="c1"># Get the changes for a specific field.</span>
<span class="n">person</span><span class="o">.</span><span class="n">name_change</span> <span class="c1">#=&gt; [ "Alan Parsons", "Alan Garner" ]</span>

<span class="c1"># Get the previous value for a field.</span>
<span class="n">person</span><span class="o">.</span><span class="n">name_was</span> <span class="c1">#=&gt; "Alan Parsons"</span>
</pre></div>
</div>
</div>
<div class="section" id="resetting-changes">
<h4>Resetting Changes<a class="headerlink" href="#resetting-changes" title="Permalink to this headline">¶</a></h4>
<p>You can reset changes of a field to its previous value by calling the reset method.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">first</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Alan Garner"</span>

<span class="c1"># Reset the changed name back to the original</span>
<span class="n">person</span><span class="o">.</span><span class="n">reset_name!</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="c1">#=&gt; "Alan Parsons"</span>
</pre></div>
</div>
</div>
<div class="section" id="notes-on-persistence">
<h4>Notes On Persistence<a class="headerlink" href="#notes-on-persistence" title="Permalink to this headline">¶</a></h4>
<p>Mongoid uses dirty tracking as the core of its persistence operations. It looks at the
changes on a document and atomically updates only what has changed unlike other frameworks
that write the entire document on each save. If no changes have been made, Mongoid will
not hit the database on a call to <tt class="docutils literal"><span class="pre">Model#save</span></tt>.</p>
</div>
<div class="section" id="viewing-previous-changes">
<h4>Viewing Previous Changes<a class="headerlink" href="#viewing-previous-changes" title="Permalink to this headline">¶</a></h4>
<p>After a document has been persisted, you can see what the changes were previously by
calling <tt class="docutils literal"><span class="pre">Model#previous_changes</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">first</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Alan Garner"</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span> <span class="c1">#=&gt; Clears out current changes.</span>

<span class="c1"># View the previous changes.</span>
<span class="n">person</span><span class="o">.</span><span class="n">previous_changes</span> <span class="c1">#=&gt; { "name" =&gt; [ "Alan Parsons", "Alan Garner" ] }</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="readonly-attributes">
<h3>Readonly Attributes<a class="headerlink" href="#readonly-attributes" title="Permalink to this headline">¶</a></h3>
<p>You can tell Mongoid that certain attributes are readonly. This will allow documents to be
created with theses attributes, but changes to them will be filtered out.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:origin</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">attr_readonly</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:origin</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Placebo"</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span> <span class="c1"># Filters out the name change.</span>
</pre></div>
</div>
<p>If you explicitly try to update or remove the attribute by itself, then a <tt class="docutils literal"><span class="pre">ReadonlyAttribute</span></tt>
error will be raised.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"Tool"</span><span class="p">)</span> <span class="c1"># Raises the error.</span>
<span class="n">band</span><span class="o">.</span><span class="n">remove_attribute</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="c1"># Raises the error.</span>
</pre></div>
</div>
</div>
<div class="section" id="inheritance">
<h3>Inheritance<a class="headerlink" href="#inheritance" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supports inheritance in both root and embedded documents. In scenarios where
documents are inherited from their fields, relations, validations and scopes get copied
down into their child documents, but not vise-versa.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Canvas</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embeds_many</span> <span class="ss">:shapes</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Browser</span> <span class="o">&lt;</span> <span class="no">Canvas</span>
  <span class="n">field</span> <span class="ss">:version</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">:version</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Firefox</span> <span class="o">&lt;</span> <span class="no">Browser</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Shape</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">field</span> <span class="ss">:y</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">embedded_in</span> <span class="ss">:canvas</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Circle</span> <span class="o">&lt;</span> <span class="no">Shape</span>
  <span class="n">field</span> <span class="ss">:radius</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Rectangle</span> <span class="o">&lt;</span> <span class="no">Shape</span>
  <span class="n">field</span> <span class="ss">:width</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>
  <span class="n">field</span> <span class="ss">:height</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In the above example, <tt class="docutils literal"><span class="pre">Canvas</span></tt>, <tt class="docutils literal"><span class="pre">Browser</span></tt> and <tt class="docutils literal"><span class="pre">Firefox</span></tt> will all save in the canvases
collection. An additional attribute <tt class="docutils literal"><span class="pre">_type</span></tt> is stored in order to make sure when loaded
from the database the correct document is returned. This also holds true for the embedded
documents <tt class="docutils literal"><span class="pre">Circle</span></tt>, <tt class="docutils literal"><span class="pre">Rectangle</span></tt>, and <tt class="docutils literal"><span class="pre">Shape</span></tt>.</p>
<div class="section" id="querying-subclasses">
<h4>Querying Subclasses<a class="headerlink" href="#querying-subclasses" title="Permalink to this headline">¶</a></h4>
<p>Querying for subclasses is handled in the normal manner, and although the documents are
all in the same collection, queries will only return documents of the correct type,
similar to Single Table Inheritance in ActiveRecord.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Returns Canvas documents and subclasses</span>
<span class="no">Canvas</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Paper"</span><span class="p">)</span>
<span class="c1"># Returns only Firefox documents</span>
<span class="no">Firefox</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Window 1"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="associations">
<h4>Associations<a class="headerlink" href="#associations" title="Permalink to this headline">¶</a></h4>
<p>You can add any type of subclass to a has one or has many association, through either normal
setting or through the build and create methods on the association:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">firefox</span> <span class="o">=</span> <span class="no">Firefox</span><span class="o">.</span><span class="n">new</span>
<span class="c1"># Builds a Shape object</span>
<span class="n">firefox</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">build</span><span class="p">({</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="c1"># Builds a Circle object</span>
<span class="n">firefox</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">build</span><span class="p">({</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="no">Circle</span><span class="p">)</span>
<span class="c1"># Creates a Rectangle object</span>
<span class="n">firefox</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">create</span><span class="p">({</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="no">Rectangle</span><span class="p">)</span>

<span class="n">rect</span> <span class="o">=</span> <span class="no">Rectangle</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">width</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="ss">height</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">firefox</span><span class="o">.</span><span class="n">shapes</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="timestamping">
<h3>Timestamping<a class="headerlink" href="#timestamping" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supplies a timestamping module in <tt class="docutils literal"><span class="pre">Mongoid::Timestamps</span></tt> which
can be included to get basic behavior for <tt class="docutils literal"><span class="pre">created_at</span></tt> and
<tt class="docutils literal"><span class="pre">updated_at</span></tt> fields.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You may also choose to only have specific timestamps for creation or
modification.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span><span class="o">::</span><span class="no">Created</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span><span class="o">::</span><span class="no">Updated</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If you want to turn off timestamping for specific calls, use the timeless
method:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">timeless</span><span class="o">.</span><span class="n">save</span>
<span class="no">Person</span><span class="o">.</span><span class="n">timeless</span><span class="o">.</span><span class="n">create!</span>
</pre></div>
</div>
<p>If you’d like shorter timestamp fields with aliases on them to save space,
you can include the short versions of the modules.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span><span class="o">::</span><span class="no">Short</span> <span class="c1"># For c_at and u_at.</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span><span class="o">::</span><span class="ss">Created</span><span class="p">:</span><span class="ss">:Short</span> <span class="c1"># For c_at only.</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span><span class="o">::</span><span class="ss">Updated</span><span class="p">:</span><span class="ss">:Short</span> <span class="c1"># For u_at only.</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="persistence">
<h2>Persistence<a class="headerlink" href="#persistence" title="Permalink to this headline">¶</a></h2>
<p>Mongoid supports all expected CRUD operations for those familiar with other Ruby mappers
like Active Record or Data Mapper. What distinguishes Mongoid from other mappers for MongoDB
is that the general persistence operations perform atomic updates on only the fields that have
changed instead of writing the entire document to the database each time.</p>
<p>The persistence sections will provide examples on what database operation is performed
when executing the documented command.</p>
<div class="section" id="standard">
<h3>Standard<a class="headerlink" href="#standard" title="Permalink to this headline">¶</a></h3>
<p>Mongoid’s standard persistence methods come in the form of common methods you would find
in other mapping frameworks. The following table shows all standard operations with
examples.</p>
<table class="docutils" border="1">
<colgroup>
<col width="33%">
<col width="67%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model.create</span></tt></p>
<p class="last"><em>Insert a document or multiple documents into the database.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span>
  <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span>
<span class="p">)</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">[</span>
  <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Willy"</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Brandt"</span> <span class="p">}</span>
<span class="o">]</span><span class="p">)</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
  <span class="n">doc</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">"Heine"</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model.create!</span></tt></p>
<p class="last"><em>Insert a document or multiple documents into the database, raising an error
if a validation error occurs.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span>
  <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span>
<span class="p">)</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">[</span>
  <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Willy"</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Brandt"</span> <span class="p">}</span>
<span class="o">]</span><span class="p">)</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
  <span class="n">doc</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">"Heine"</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#save</span></tt></p>
<p class="last"><em>Saves the changed attributes to the database atomically, or insert the document
if flagged as a new record via</em> <tt class="docutils literal"><span class="pre">Model#new_record?</span></tt> <em>. Can bypass validations if wanted.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span>
  <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>

<span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Christian Johan"</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#save!</span></tt></p>
<p class="last"><em>Saves the changed attributes to the database atomically, or insert the document if
new. Will raise an error of validations fail.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span>
  <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">save!</span>

<span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Christian Johan"</span>
<span class="n">person</span><span class="o">.</span><span class="n">save!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#update_attributes</span></tt></p>
<p class="last"><em>Update the provided attributes (and any other dirty fields).</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">update_attributes!</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Jean"</span><span class="p">,</span>
  <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Zorg"</span>
<span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#update_attribute</span></tt></p>
<p class="last"><em>Update a single attribute, bypassing validations.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="s2">"Jean"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#upsert</span></tt></p>
<p class="last"><em>Performs a MongoDB upsert on the document. If the document exists in the database,
it will get overwritten with the current attributes of the document in memory.
If the document does not exist in the database, it will be inserted. Note that
this only runs the</em> <tt class="docutils literal"><span class="pre">{before|after|around}_upsert</span></tt> <em>callbacks.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="n">first_name</span><span class="p">:</span> <span class="s2">"Heinrich"</span><span class="p">,</span>
  <span class="n">last_name</span><span class="p">:</span> <span class="s2">"Heine"</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">upsert</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#touch</span></tt></p>
<p class="last"><em>Update the document’s updated_at timestamp, optionally with one extra provided
time field. This will cascade the touch to all</em> <tt class="docutils literal"><span class="pre">belongs_to</span></tt> <em>relations of the document
with the option set. This operation skips validations and callbacks.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">touch</span>
<span class="n">person</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="ss">:audited_at</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#delete</span></tt></p>
<p class="last"><em>Deletes the document from the database without running callbacks.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#destroy</span></tt></p>
<p class="last"><em>Deletes the document from the database while running destroy callbacks.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model.delete_all</span></tt></p>
<p class="last"><em>Deletes all documents from the database without running any callbacks.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Person</span><span class="o">.</span><span class="n">delete_all</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model.destroy_all</span></tt></p>
<p class="last"><em>Deletes all documents from the database while running callbacks. This is a
potentially expensive operation since all documents will be loaded into memory.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Person</span><span class="o">.</span><span class="n">destroy_all</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="atomic">
<h3>Atomic<a class="headerlink" href="#atomic" title="Permalink to this headline">¶</a></h3>
<p>Although Mongoid performs atomic operations under the covers by default, there may be cases
where you want to do this explicitly without persisting other fields. Mongoid provides support
for all of these operations as well. When executing atomic operations via these methods,
no callbacks will ever get run, nor will any validations.</p>
<table class="docutils" border="1">
<colgroup>
<col width="33%">
<col width="67%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#add_to_set</span></tt></p>
<p class="last"><em>Performs an atomic $addToSet on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">add_to_set</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="s2">"Bond"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#bit</span></tt></p>
<p class="last"><em>Performs an atomic $bit on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">bit</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="p">{</span> <span class="ow">and</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ow">or</span><span class="p">:</span> <span class="mi">12</span> <span class="p">})</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#inc</span></tt></p>
<p class="last"><em>Performs an atomic $inc on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#pop</span></tt></p>
<p class="last"><em>Performs an atomic $pop on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#pull</span></tt></p>
<p class="last"><em>Performs an atomic $pull on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="s2">"Bond"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#pull_all</span></tt></p>
<p class="last"><em>Performs an atomic $pullAll on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">pull_all</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="o">[</span> <span class="s2">"Bond"</span><span class="p">,</span> <span class="s2">"James"</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#push</span></tt></p>
<p class="last"><em>Performs an atomic $push on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="o">[</span><span class="s2">"007"</span><span class="p">,</span><span class="s2">"008"</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#rename</span></tt></p>
<p class="last"><em>Performs an atomic $rename on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="ss">bday</span><span class="p">:</span> <span class="ss">:dob</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#set</span></tt></p>
<p class="last"><em>Performs an atomic $set on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tyler Durden"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Model#unset</span></tt></p>
<p class="last"><em>Performs an atomic $unset on the field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">person</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="custom">
<h3>Custom<a class="headerlink" href="#custom" title="Permalink to this headline">¶</a></h3>
<p>There may be cases where you want to persist documents to different sources from their
defaults, or with different options from the default. Mongoid provides run-time support
for this as well as support on a per-model basis.</p>
<div class="section" id="model-level-persistence-options">
<h4>Model Level Persistence Options<a class="headerlink" href="#model-level-persistence-options" title="Permalink to this headline">¶</a></h4>
<p>On a per-model basis, you can tell it to store in a custom collection name, a different
database, or a different session. The following example would store the Band class by
default into a collection named “artists” in the database named “music”, with the session “secondary”.</p>
<p>Note that the value supplied to the <tt class="docutils literal"><span class="pre">client</span></tt> option must be configured under <tt class="docutils literal"><span class="pre">clients</span></tt>
in your mongoid.yml.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">store_in</span> <span class="ss">collection</span><span class="p">:</span> <span class="s2">"artists"</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s2">"music"</span><span class="p">,</span> <span class="ss">client</span><span class="p">:</span> <span class="s2">"secondary"</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If no <tt class="docutils literal"><span class="pre">store_in</span></tt> macro would have been provided, Mongoid would store the model in a
collection named “bands” in the default database in the default session.</p>
</div>
<div class="section" id="runtime-persistence-options">
<h4>Runtime Persistence Options<a class="headerlink" href="#runtime-persistence-options" title="Permalink to this headline">¶</a></h4>
<p>You can change at runtime where to store, query, update, or remove documents by prefixing
any operation with <tt class="docutils literal"><span class="pre">#with</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">database</span><span class="p">:</span> <span class="s2">"music-non-stop"</span><span class="p">)</span><span class="o">.</span><span class="n">create</span>
<span class="no">Band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">collection</span><span class="p">:</span> <span class="s2">"artists"</span><span class="p">)</span><span class="o">.</span><span class="n">delete_all</span>
<span class="n">band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">client</span><span class="p">:</span> <span class="ss">:tertiary</span><span class="p">)</span><span class="o">.</span><span class="n">save!</span>
</pre></div>
</div>
<p>Persisting using with is a one time switch in the persistence context - it creates a new
client under the cover which will get garbage collected after use. Mongoid will not remember
anything specific on the document level regarding how it was saved when using this method.
A potential gotcha with this is persisting a document via with and then immediately updating it after.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Scuba"</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">collection</span><span class="p">:</span> <span class="s2">"artists"</span><span class="p">)</span><span class="o">.</span><span class="n">save!</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># This will not save - tries the collection "bands"</span>
<span class="n">band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">collection</span><span class="p">:</span> <span class="s2">"artists"</span><span class="p">)</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># This will update the document.</span>
</pre></div>
</div>
<p>Also note that because a new client is created, not to change any options that would cause
a cluster configuration change and instantiate a client that would <em>never</em> get garbage collected
due to the new cluster’s monitor threads. To avoid this, <em>only</em> use <tt class="docutils literal"><span class="pre">with</span></tt> when changing the
following options:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">database</span></tt></li>
<li><tt class="docutils literal"><span class="pre">collection</span></tt></li>
<li><tt class="docutils literal"><span class="pre">client</span></tt></li>
<li><tt class="docutils literal"><span class="pre">read</span></tt></li>
<li><tt class="docutils literal"><span class="pre">write</span></tt></li>
</ul>
<p>If you want to switch the persistence context for all operations at runtime, but don’t want
to be using with all over your code, Mongoid provides the ability to do this as the client
and database level globally. The methods for this are <tt class="docutils literal"><span class="pre">Mongoid.override_client</span></tt> and
<tt class="docutils literal"><span class="pre">Mongoid.override_database</span></tt>. A useful case for this are internationalized applications
that store information for different locales in different databases or sessions, but the
schema in each remains the same.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BandsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:switch_database</span>
  <span class="n">after_filter</span> <span class="ss">:reset_database</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">switch_database</span>
    <span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:locale</span><span class="o">]</span> <span class="o">||</span> <span class="no">I18n</span><span class="o">.</span><span class="n">default_locale</span>
    <span class="no">Mongoid</span><span class="o">.</span><span class="n">override_database</span><span class="p">(</span><span class="s2">"my_db_name_</span><span class="si">#{</span><span class="no">I18n</span><span class="o">.</span><span class="n">locale</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">reset_database</span>
    <span class="no">Mongoid</span><span class="o">.</span><span class="n">override_database</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In the above example, all persistence operations would be stored in the alternative
database for all remaining operations on this thread. This is why the after request
set the override back to nil - it ensures subsequent requests with no local params
use the default option.</p>
</div>
<div class="section" id="client-and-collection-access">
<h4>Client and Collection Access<a class="headerlink" href="#client-and-collection-access" title="Permalink to this headline">¶</a></h4>
<p>If you want to drop down to the driver level to perform operations, you can grab
the Mongo client or collection from the model or document instance.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">mongo_client</span>
<span class="n">band</span><span class="o">.</span><span class="n">mongo_client</span>
<span class="no">Band</span><span class="o">.</span><span class="n">collection</span>
<span class="n">band</span><span class="o">.</span><span class="n">collection</span>
</pre></div>
</div>
<p>From here you also have the same runtime persistence options using the driver’s <tt class="docutils literal"><span class="pre">#with</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">client</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">mongo_client</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write</span><span class="p">:</span> <span class="p">{</span> <span class="ss">w</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="ss">database</span><span class="p">:</span> <span class="s2">"musik"</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="capped-collections">
<h4>Capped Collections<a class="headerlink" href="#capped-collections" title="Permalink to this headline">¶</a></h4>
<p>Mongoid does not provide a mechanism for creating capped collections on the fly - you
will need to create these yourself one time up front either with the driver or via the
Mongo console.</p>
<p>To create a capped collection with the driver:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">client</span><span class="o">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:capped</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="o">].</span><span class="n">create</span>
</pre></div>
</div>
<p>To create a capped collection from the Mongo console:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="p">{</span> <span class="nx">capped</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">1024</span> <span class="p">});</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>Querying<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>One of MongoDB’s greatest features is its ability to execute dynamic
queries, which Origin abstracts in a familiar Arel-style DSL that
Mongoid includes.</p>
<div class="section" id="queries">
<h3>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h3>
<p>All queries in Mongoid are <tt class="docutils literal"><span class="pre">Mongoid::Criteria</span></tt>, which is a chainable and
lazily evaluated wrapper to a MongoDB dynamic query. Criteria only
touch the database when they need to, for example on iteration of the
results, and when executed wrap a cursor in order to keep memory
management and performance predictable.</p>
<div class="section" id="queryable-dsl">
<h4>Queryable DSL<a class="headerlink" href="#queryable-dsl" title="Permalink to this headline">¶</a></h4>
<p>Mongoid’s main query DSL is provided by Origin. Any method that is available
on an <tt class="docutils literal"><span class="pre">Origin::Queryable</span></tt> exists on a <tt class="docutils literal"><span class="pre">Mongoid::Criteria</span></tt>
<em>as well as</em> off the model’s class.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Depeche Mode"</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span>
  <span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gte</span> <span class="o">=&gt;</span> <span class="s2">"1980-1-1"</span><span class="p">)</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">"Tool"</span><span class="p">,</span> <span class="s2">"Deftones"</span> <span class="o">]</span><span class="p">)</span><span class="o">.</span>
  <span class="n">union</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">"Melvins"</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>With each chained method on a criteria, a newly cloned criteria
is returned with the new query added. This is so that with scoping
or exposures, for example, the original queries are unmodified
and remain reusable.</p>
</div>
<div class="section" id="additional-query-methods">
<h4>Additional Query Methods<a class="headerlink" href="#additional-query-methods" title="Permalink to this headline">¶</a></h4>
<p>In addition to behavior that Origin provides, Mongoid also has some helpful
methods on criteria.</p>
<table class="docutils" border="1">
<colgroup>
<col width="33%">
<col width="67%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#count</span></tt></p>
<p class="last"><em>Get a count of persisted documents. Note this will always hit
the database for the count.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#distinct</span></tt></p>
<p class="last"><em>Get a list of distinct values for a single field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:fans</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span>
  <span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#each</span></tt></p>
<p class="last"><em>Iterate over all matching documents in the criteria.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#exists?</span></tt></p>
<p class="last"><em>Determine if any matching documents exist. Will return true if there
are 1 or more.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">exists?</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">exists?</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find</span></tt></p>
<p class="last"><em>Find a document or multiple documents by their ids. Will raise
an error by default if any of the ids do not match.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"4baa56f1230048567300485c"</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
  <span class="s2">"4baa56f1230048567300485c"</span><span class="p">,</span>
  <span class="s2">"4baa56f1230048567300485d"</span>
<span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
  <span class="s2">"4baa56f1230048567300485c"</span>
<span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find_by</span></tt></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
raise an error or return nil depending on the
* ``raise_not_found_error`` *configuration option.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="n">band</span><span class="o">.</span><span class="n">impressions</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find_or_create_by</span></tt></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
create and return a newly persisted one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find_or_initialize_by</span></tt></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first|last</span></tt></p>
<p class="last"><em>Finds a single document given the provided criteria. This guarantees no order.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first_or_create</span></tt></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first_or_create!</span></tt></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one using</em> <tt class="docutils literal"><span class="pre">create!</span></tt>.</p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first_or_initialize</span></tt></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_initialize</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#for_js</span></tt></p>
<p class="last"><em>Find documents for a provided javascript expression. This will
wrap the javascript in a `BSON::Code` object which is the
safe way to avoid javascript injection attacks.*</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">for_js</span><span class="p">(</span><span class="s2">"this.name = param"</span><span class="p">,</span> <span class="ss">param</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#length|size</span></tt></p>
<p class="last"><em>Same as count but caches subsequent calls to the database</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">length</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"FKA Twigs"</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pluck</span></tt></p>
<p class="last"><em>Get all the non nil values for the provided field.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="eager-loading">
<h4>Eager Loading<a class="headerlink" href="#eager-loading" title="Permalink to this headline">¶</a></h4>
<p>Mongoid provides a facility to eager load documents
from relations to prevent the n+1 issue when
iterating over documents with relation access. Eager loaded is supported on
all relations with the exception of polymorphic <tt class="docutils literal"><span class="pre">belongs_to&lt;</span></tt>
associations.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:albums</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">albums</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span> <span class="c1"># Does not hit the database again.</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="queries-persistence">
<h3>Queries + Persistence<a class="headerlink" href="#queries-persistence" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supports persistence operations off of criteria
in a light capacity for when you want to expressively perform multi
document inserts, updates, and deletion.</p>
<table class="docutils" border="1">
<colgroup>
<col width="33%">
<col width="67%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#create</span></tt></p>
<p class="last"><em>Create a newly persisted document.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">create</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#create!</span></tt></p>
<p class="last"><em>Create a newly persisted document and raise an exception on validation failure.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">create!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#build|new</span></tt></p>
<p class="last"><em>Create a new (unsaved) document.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">build</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#update</span></tt></p>
<p class="last"><em>Update attributes of the first matching document.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">"Mute"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#update_all</span></tt></p>
<p class="last"><em>Update attributes of all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">"Mute"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#add_to_set</span></tt></p>
<p class="last"><em>Perform an $addToSet on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_set</span><span class="p">(</span><span class="ss">:label</span><span class="p">,</span> <span class="s2">"Mute"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#bit</span></tt></p>
<p class="last"><em>Perform a $bit on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">bit</span><span class="p">(</span><span class="ss">:likes</span><span class="p">,</span> <span class="p">{</span> <span class="ow">and</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">or</span><span class="p">:</span> <span class="mi">4</span> <span class="p">})</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#inc</span></tt></p>
<p class="last"><em>Perform an $inc on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pop</span></tt></p>
<p class="last"><em>Perform a $pop on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Photek"</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pull</span></tt></p>
<p class="last"><em>Perform a $pull on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">"Maynard"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pull_all</span></tt></p>
<p class="last"><em>Perform a $pullAll on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span>
  <span class="n">pull_all</span><span class="p">(</span><span class="ss">:members</span><span class="p">,</span> <span class="o">[</span> <span class="s2">"Maynard"</span><span class="p">,</span> <span class="s2">"Danny"</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#push</span></tt></p>
<p class="last"><em>Perform a $push on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">"Maynard"</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#push_all</span></tt></p>
<p class="last"><em>Perform a $pushAll on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span>
  <span class="n">push_all</span><span class="p">(</span><span class="ss">:members</span><span class="p">,</span> <span class="o">[</span> <span class="s2">"Maynard"</span><span class="p">,</span> <span class="s2">"Danny"</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#rename</span></tt></p>
<p class="last"><em>Perform a $rename on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:title</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#set</span></tt></p>
<p class="last"><em>Perform a $set on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#unset</span></tt></p>
<p class="last"><em>Perform a $unset on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Tool"</span><span class="p">)</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="ss">:likes</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#delete</span></tt></p>
<p class="last"><em>Deletes all matching documents in the database.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">"Mute"</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#destroy</span></tt></p>
<p class="last"><em>Deletes all matching documents in the database while running callbacks for all.
This loads all documents into memory and can be an expensive operation.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">"Mute"</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="scoping">
<h3>Scoping<a class="headerlink" href="#scoping" title="Permalink to this headline">¶</a></h3>
<p>Scopes provide a convenient way to reuse common criteria with more
business domain style syntax.</p>
<div class="section" id="named-scopes">
<h4>Named Scopes<a class="headerlink" href="#named-scopes" title="Permalink to this headline">¶</a></h4>
<p>Named scopes are simply criteria defined at class load that are referenced
by a provided name. Just like normal criteria, they are lazy and chainable.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:genres</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">scope</span> <span class="ss">:english</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="s2">"England"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:rock</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">:genres</span><span class="o">.</span><span class="n">in</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">"rock"</span> <span class="o">]</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">english</span><span class="o">.</span><span class="n">rock</span> <span class="c1"># Get the English rock bands.</span>
</pre></div>
</div>
<dl class="docutils">
<dt>%p</dt>
<dd>Named scopes can take procs and blocks for accepting parameters or
extending functionality.</dd>
</dl>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">scope</span> <span class="ss">:named</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">){</span> <span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">deutsch</span>
        <span class="n">tap</span> <span class="o">|</span><span class="n">scope</span><span class="o">|</span> <span class="k">do</span>
          <span class="n">scope</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">"origin"</span> <span class="o">=&gt;</span> <span class="s2">"Deutschland"</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s2">"Depeche Mode"</span><span class="p">)</span> <span class="c1"># Find Depeche Mode.</span>
<span class="no">Band</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">deutsch</span> <span class="c1"># Find active German bands.</span>
</pre></div>
</div>
</div>
<div class="section" id="default-scopes">
<h4>Default Scopes<a class="headerlink" href="#default-scopes" title="Permalink to this headline">¶</a></h4>
<p>Default scopes can be useful when you find yourself applying the same
criteria to most queries, and want something to be there by default.
Default scopes take procs that return criteria objects.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="c1"># All bands here are active.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can tell Mongoid not to apply the default scope by using
<tt class="docutils literal"><span class="pre">unscoped</span></tt>, which can be inline or take a block.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Depeche Mode"</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Depeche Mode"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can also tell Mongoid to explicitly apply the default scope
again later to always ensure it’s there.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Depeche Mode"</span><span class="p">)</span><span class="o">.</span><span class="n">scoped</span>
</pre></div>
</div>
<p>If you are using a default scope on a model that is part of a relation,
you must reload the relation to have scoping reapplied.
This is important to note if you change a value of a document in the relation
that would affect its visibility within the scoped relation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">embedded_in</span> <span class="ss">:label</span>
  <span class="n">default_scoped</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">label</span><span class="o">.</span><span class="n">bands</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1">#=&gt; [ band ]</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1">#=&gt; [ band ] Must reload.</span>
<span class="n">label</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">bands</span> <span class="c1">#=&gt; []</span>
</pre></div>
</div>
</div>
<div class="section" id="class-methods">
<h4>Class Methods<a class="headerlink" href="#class-methods" title="Permalink to this headline">¶</a></h4>
<p>Class methods on models that return criteria objects are also
treated like scopes, and can be chained as well.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">active</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">active</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="map-reduce">
<h3>Map/Reduce<a class="headerlink" href="#map-reduce" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides a DSL around MongoDB’s map/reduce framework, for performing
custom map/reduce jobs or simple aggregations.</p>
<div class="section" id="execution">
<h4>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h4>
<p>You can tell Mongoid off the class or a criteria to perform a map/reduce
by calling <tt class="docutils literal"><span class="pre">map_reduce</span></tt> and providing map and reduce javascript
functions.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">map</span> <span class="o">=</span> <span class="sx">%Q{</span>
<span class="sx">  function() {</span>
<span class="sx">    emit(this.name, { likes: this.likes });</span>
<span class="sx">  }</span>
<span class="sx">}</span>

<span class="n">reduce</span> <span class="o">=</span> <span class="sx">%Q{</span>
<span class="sx">  function(key, values) {</span>
<span class="sx">    var result = { likes: 0 };</span>
<span class="sx">    values.forEach(function(value) {</span>
<span class="sx">      result.likes += value.likes;</span>
<span class="sx">    });</span>
<span class="sx">    return result;</span>
<span class="sx">  }</span>
<span class="sx">}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">inline</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</pre></div>
</div>
<p>Just like criteria, map/reduce calls are lazily evaluated. So nothing will
hit the database until you iterate over the results, or make a call on the
wrapper that would need to force a database hit.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">replace</span><span class="p">:</span> <span class="s2">"mr-results"</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">document</span> <span class="c1"># { "_id" =&gt; "Tool", "value" =&gt; { "likes" =&gt; 200 }}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The only required thing you provide along with a map/reduce is where to
output the results. If you do not provide this an error will be raised.
Valid options to <tt class="docutils literal"><span class="pre">#out</span></tt> are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">inline:</span> <span class="pre">1</span></tt>: Don’t store the output in a collection.</li>
<li><tt class="docutils literal"><span class="pre">replace:</span> <span class="pre">"name"</span></tt>: Store in a collection with the
provided name, and overwrite any documents that exist in it.</li>
<li><tt class="docutils literal"><span class="pre">merge:</span> <span class="pre">"name"</span></tt>: Store in a collection with the
provided name, and merge the results with the existing documents.</li>
<li><tt class="docutils literal"><span class="pre">reduce:</span> <span class="pre">"name"</span></tt>: Store in a collection with the
provided name, and reduce all existing results in that collection.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="relations">
<h2>Relations<a class="headerlink" href="#relations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="common-behaviour">
<h3>Common Behaviour<a class="headerlink" href="#common-behaviour" title="Permalink to this headline">¶</a></h3>
<div class="section" id="attributes">
<h4>Attributes<a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h4>
<p>All relations contain a <tt class="docutils literal"><span class="pre">target</span></tt>, which is the proxied document or documents, a <tt class="docutils literal"><span class="pre">base</span></tt>
which is the document the relation hangs off, and <tt class="docutils literal"><span class="pre">metadata</span></tt> which provides information
about the relation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:addresses</span>
<span class="k">end</span>

<span class="n">person</span><span class="o">.</span><span class="n">addresses</span> <span class="o">=</span> <span class="o">[</span> <span class="n">address</span> <span class="o">]</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">target</span> <span class="c1"># returns [ address ]</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">base</span> <span class="c1"># returns person</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">metadata</span> <span class="c1"># returns the metadata</span>
</pre></div>
</div>
</div>
<div class="section" id="extensions">
<h4>Extensions<a class="headerlink" href="#extensions" title="Permalink to this headline">¶</a></h4>
<p>All relations can have extensions, which provides a way to add application specific
functionality to the relation. They are defined by providing a block to the relation definition.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:addresses</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_country</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
      <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="n">country</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">chinese</span>
      <span class="vi">@target</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span> <span class="n">address</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s2">"China"</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">find_by_country</span><span class="p">(</span><span class="s2">"Mongolia"</span><span class="p">)</span> <span class="c1"># returns address</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">chinese</span> <span class="c1"># returns [ address ]</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-relation-names">
<h4>Custom Relation Names<a class="headerlink" href="#custom-relation-names" title="Permalink to this headline">¶</a></h4>
<p>You can name your relations whatever you like, but if the class cannot be inferred by
Mongoid from the name, and neither can the opposite side you’ll want to provide the
macro with some additional options to tell Mongoid how to hook them up.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Lush</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_one</span> <span class="ss">:whiskey</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s2">"Drink"</span><span class="p">,</span> <span class="n">inverse_of</span><span class="p">:</span> <span class="ss">:alcoholic</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Drink</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embedded_in</span> <span class="ss">:alcoholic</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s2">"Lush"</span><span class="p">,</span> <span class="n">inverse_of</span><span class="p">:</span> <span class="ss">:whiskey</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="validations">
<h4>Validations<a class="headerlink" href="#validations" title="Permalink to this headline">¶</a></h4>
<p>It is important to note that by default, Mongoid will validate the children of any
relation that are loaded into memory via a <tt class="docutils literal"><span class="pre">validates_associated</span></tt>. The relations that
this applies to are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">embeds_many</span></tt></li>
<li><tt class="docutils literal"><span class="pre">embeds_one</span></tt></li>
<li><tt class="docutils literal"><span class="pre">has_many</span></tt></li>
<li><tt class="docutils literal"><span class="pre">has_one</span></tt></li>
<li><tt class="docutils literal"><span class="pre">has_and_belongs_to_many</span></tt></li>
</ul>
<p>If you do not want this behavior, you may turn it off when defining the relation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>

  <span class="n">embeds_many</span> <span class="ss">:addresses</span><span class="p">,</span> <span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span>
  <span class="n">has_many</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="polymorphism">
<h4>Polymorphism<a class="headerlink" href="#polymorphism" title="Permalink to this headline">¶</a></h4>
<p>When a child embedded document can belong to more than one type of parent document, you can
tell Mongoid to support this by adding the <tt class="docutils literal"><span class="pre">as</span></tt> option to the definition on the parents,
and the <tt class="docutils literal"><span class="pre">polymorphic</span></tt> option on the child. On the child object, an additional field will
be stored that indicates the type of the parent. Polymorphic behavior is allowed on all
relations with the exception of <tt class="docutils literal"><span class="pre">has_and_belongs_to_many</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:photographic</span>
  <span class="n">has_one</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:addressable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Photo</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embedded_in</span> <span class="ss">:photographic</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Address</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">belongs_to</span> <span class="ss">:addressable</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="cascading-callbacks">
<h4>Cascading Callbacks<a class="headerlink" href="#cascading-callbacks" title="Permalink to this headline">¶</a></h4>
<p>If you want the embedded document callbacks to fire when calling a persistence operation on
its parent, you will need to provide the cascade callbacks option to the relation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="n">cascade_callbacks</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span><span class="p">,</span> <span class="n">cascade_callbacks</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span><span class="o">.</span><span class="n">save</span> <span class="c1"># Fires all save callbacks on the band, albums, and label.</span>
</pre></div>
</div>
</div>
<div class="section" id="dependent-behaviour">
<h4>Dependent Behaviour<a class="headerlink" href="#dependent-behaviour" title="Permalink to this headline">¶</a></h4>
<p>You can provided dependent options to referenced associations to instruct Mongoid
how to handle situations where one side of the relation is deleted, or is attempted
to be deleted. The options are as follows:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">:delete</span></tt>: Delete the child document without run any of the model callbacks.</li>
<li><tt class="docutils literal"><span class="pre">:destroy</span></tt>: Destroy the child document running all of the model callbacks.</li>
<li><tt class="docutils literal"><span class="pre">:nullify</span></tt>: Orphan the child document.</li>
<li><tt class="docutils literal"><span class="pre">:restrict</span></tt>: Raise an error if the child is not empty.</li>
</ul>
<p>The default behavior of each association when no dependent option is provided is to nullify.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:delete</span>
  <span class="n">belongs_to</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:nullify</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_many</span> <span class="ss">:bands</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:restrict</span>
<span class="k">end</span>

<span class="n">label</span> <span class="o">=</span> <span class="no">Label</span><span class="o">.</span><span class="n">first</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">delete</span> <span class="c1"># Raises an error since bands is not empty.</span>

<span class="no">Band</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">delete</span> <span class="c1"># Will delete all associated albums.</span>
</pre></div>
</div>
</div>
<div class="section" id="autosaving">
<h4>Autosaving<a class="headerlink" href="#autosaving" title="Permalink to this headline">¶</a></h4>
<p>One core difference between Mongoid and Active Record from a behavior standpoint
is that Mongoid does not automatically save child relations for relational associations.
This is for performance reasons.</p>
<p>To enable an autosave on a relational association (embedded associations do not need
this since they are actually part of the parent in the database) add the autosave
option to the relation.</p>
<p>Note that autosave functionality will automatically be added to a relation when using
<tt class="docutils literal"><span class="pre">accepts_nested_attributes_for</span></tt> or validating presence of the relation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">autosave</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">albums</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"101"</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">save</span> <span class="c1">#=&gt; Will save the album as well.</span>
</pre></div>
</div>
</div>
<div class="section" id="recursive-embedding">
<h4>Recursive Embedding<a class="headerlink" href="#recursive-embedding" title="Permalink to this headline">¶</a></h4>
<p>A document can recursively embed itself using <tt class="docutils literal"><span class="pre">recursively_embeds_one</span></tt> or <tt class="docutils literal"><span class="pre">recursively_embeds_many</span></tt>,
which provides accessors for the parent and children via <tt class="docutils literal"><span class="pre">parent_</span></tt> and <tt class="docutils literal"><span class="pre">child_</span></tt> methods.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">recursively_embeds_many</span>
<span class="k">end</span>

<span class="n">root</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"programming"</span><span class="p">)</span>
<span class="n">child_one</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child_tags</span><span class="o">.</span><span class="n">build</span>
<span class="n">child_two</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child_tags</span><span class="o">.</span><span class="n">build</span>

<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span> <span class="c1"># [ child_one, child_two ]</span>
<span class="n">child_one</span><span class="o">.</span><span class="n">parent_tag</span> <span class="c1"># [ root ]</span>
<span class="n">child_two</span><span class="o">.</span><span class="n">parent_tag</span> <span class="c1"># [ root ]</span>

<span class="k">class</span> <span class="nc">Node</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">recursively_embeds_one</span>
<span class="k">end</span>

<span class="n">root</span> <span class="o">=</span> <span class="no">Node</span><span class="o">.</span><span class="n">new</span>
<span class="n">child</span> <span class="o">=</span> <span class="no">Node</span><span class="o">.</span><span class="n">new</span>
<span class="n">root</span><span class="o">.</span><span class="n">child_node</span> <span class="o">=</span> <span class="n">child</span>

<span class="n">root</span><span class="o">.</span><span class="n">child</span> <span class="c1"># child</span>
<span class="n">child</span><span class="o">.</span><span class="n">parent_node</span> <span class="c1"># root</span>
</pre></div>
</div>
</div>
<div class="section" id="existence-predicates">
<h4>Existence Predicates<a class="headerlink" href="#existence-predicates" title="Permalink to this headline">¶</a></h4>
<p>All relations have existence predicates on them in the form of <tt class="docutils literal"><span class="pre">name?</span></tt> and <tt class="docutils literal"><span class="pre">has_name?</span></tt>
to check if the relation is blank.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="n">band</span><span class="o">.</span><span class="n">label?</span>
<span class="n">band</span><span class="o">.</span><span class="n">has_label?</span>
<span class="n">band</span><span class="o">.</span><span class="n">albums?</span>
<span class="n">band</span><span class="o">.</span><span class="n">has_albums?</span>
</pre></div>
</div>
</div>
<div class="section" id="autobuilding">
<h4>Autobuilding<a class="headerlink" href="#autobuilding" title="Permalink to this headline">¶</a></h4>
<p>One to one relations (<tt class="docutils literal"><span class="pre">embeds_one</span></tt>, <tt class="docutils literal"><span class="pre">has_one</span></tt>) have an autobuild option which tells
Mongoid to instantiate a new document when the relation is accessed and it is <tt class="docutils literal"><span class="pre">nil</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">autobuild</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">has_one</span> <span class="ss">:producer</span><span class="p">,</span> <span class="ss">autobuild</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span>
<span class="n">band</span><span class="o">.</span><span class="n">label</span> <span class="c1"># Returns a new empty label.</span>
<span class="n">band</span><span class="o">.</span><span class="n">producer</span> <span class="c1"># Returns a new empty producer.</span>
</pre></div>
</div>
</div>
<div class="section" id="touching">
<h4>Touching<a class="headerlink" href="#touching" title="Permalink to this headline">¶</a></h4>
<p>Any <tt class="docutils literal"><span class="pre">belongs_to</span></tt> relation, no matter where it hangs off from, can take an optional <tt class="docutils literal"><span class="pre">:touch</span></tt>
option which will call the touch method on it and any parent relations with the option defined
when the base document calls <tt class="docutils literal"><span class="pre">#touch</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">belongs_to</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">touch</span> <span class="c1">#=&gt; Calls touch on the parent label.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="metadata">
<h3>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h3>
<p>All relations in Mongoid contain metadata that holds information about the relation in
question, and is a valuable tool for third party developers to use to extend Mongoid.</p>
<p>You can access the metadata of the relation in a few different ways.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Get the metadata for a named relation from the class or document.</span>
<span class="no">Model</span><span class="o">.</span><span class="n">reflect_on_association</span><span class="p">(</span><span class="ss">:relation_name</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">reflect_on_association</span><span class="p">(</span><span class="ss">:relation_name</span><span class="p">)</span>

<span class="c1"># Get the metadata that the current object has in its relation.</span>
<span class="n">model</span><span class="o">.</span><span class="n">metadata</span>

<span class="c1"># Get the metadata with a specific relation itself on a specific</span>
<span class="c1"># document.</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">metadata</span>
</pre></div>
</div>
<div class="section" id="the-metadata-object">
<h4>The Metadata Object<a class="headerlink" href="#the-metadata-object" title="Permalink to this headline">¶</a></h4>
<p>The metadata object itself contains more information than one might know what to do
with, and is useful for developers of extensions to Mongoid.</p>
<table class="docutils" border="1">
<colgroup>
<col width="33%">
<col width="67%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#as</span></tt></td>
<td>Returns the name of the parent to a polymorphic child.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#as?</span></tt></td>
<td>Returns whether or not an as option exists.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#autobuilding?</span></tt></td>
<td>Returns whether or not the relation is autobuilding.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#autosaving?</span></tt></td>
<td>Returns whether or not the relation is autosaving.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#cascading_callbacks?</span></tt></td>
<td>Returns whether the relation has callbacks cascaded down from the parent.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#class_name</span></tt></td>
<td>Returns the class name of the proxied document.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#cyclic?</span></tt></td>
<td>Returns whether the relation is a cyclic relation.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#dependent</span></tt></td>
<td>Returns the relation’s dependent option.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#dependent?</span></tt></td>
<td>Returns whether the relation is a dependent relation.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#destructive?</span></tt></td>
<td>Returns true if the relation has a dependent delete or destroy.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#embedded?</span></tt></td>
<td>Returns whether the relation is embedded in another document.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#forced_nil_inverse?</span></tt></td>
<td>Returns whether the relation has a nil inverse defined.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#foreign_key</span></tt></td>
<td>Returns the name of the foreign key field.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#foreign_key_check</span></tt></td>
<td>Returns the name of the foreign key field dirty check method.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#foreign_key_setter</span></tt></td>
<td>Returns the name of the foreign key field setter.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#indexed?</span></tt></td>
<td>Returns whether the foreign key is auto indexed.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#inverses</span></tt></td>
<td>Returns the names of all inverse relation.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#inverse</span></tt></td>
<td>Returns the name of a single inverse relation.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_class_name</span></tt></td>
<td>Returns the class name of the relation on the inverse side.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_foreign_key</span></tt></td>
<td>Returns the name of the foreign key field on the inverse side.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_klass</span></tt></td>
<td>Returns the class of the relation on the inverse side.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_metadata</span></tt></td>
<td>Returns the metadata of the relation on the inverse side.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_of</span></tt></td>
<td>Returns the explicitly defined name of the inverse relation.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_of?</span></tt></td>
<td>Returns whether an inverse_of option is defined.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_setter</span></tt></td>
<td>Returns the name of the method used to set the inverse.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_type</span></tt></td>
<td>Returns the name for the polymorphic type field of the inverse.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#inverse_type_setter</span></tt></td>
<td>Returns the name for the polymorphic type field setter of the inverse.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#key</span></tt></td>
<td>Returns the name of the field in the attributes hash to use to get the relation.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#klass</span></tt></td>
<td>Returns the class of the proxied documents in the relation.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#macro</span></tt></td>
<td>Returns the relation’s macro.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#name</span></tt></td>
<td>Returns the relation name.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#options</span></tt></td>
<td>Returns self, for API compatibility with Active Record.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#order</span></tt></td>
<td>Returns the custom sorting options on the relation.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#order?</span></tt></td>
<td>Returns whether custom sorting options are set.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#polymorphic?</span></tt></td>
<td>Returns whether the relation is polymorphic.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#setter</span></tt></td>
<td>Returns the name of the field to set the relation.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#store_as</span></tt></td>
<td>Returns the name of the attribute to store an embedded relation in.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#touchable?</span></tt></td>
<td>Returns whether or not the relation has a touch option.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#type</span></tt></td>
<td>Returns the name of the field to get the polymorphic type.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Metadata#type_setter</span></tt></td>
<td>Returns the name of the field to set the polymorphic type.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Metadata#validate?</span></tt></td>
<td>Returns whether the relation has an associated validation.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="embeds-one">
<h3>Embeds One<a class="headerlink" href="#embeds-one" title="Permalink to this headline">¶</a></h3>
<p>One to one relationships where the children are embedded in the parent document are defined
using Mongoid’s <tt class="docutils literal"><span class="pre">embeds_one</span></tt> and <tt class="docutils literal"><span class="pre">embedded_in</span></tt> macros.</p>
<div class="section" id="defining">
<h4>Defining<a class="headerlink" href="#defining" title="Permalink to this headline">¶</a></h4>
<p>The parent document of the relation should use the <tt class="docutils literal"><span class="pre">embeds_one</span></tt> macro to indicate is has 1
embedded child, where the document that is embedded uses <tt class="docutils literal"><span class="pre">embedded_in</span></tt>. Definitions are required
on both sides to the relation in order for it to work properly.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>Storage<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Documents that are embedded using the <tt class="docutils literal"><span class="pre">embeds_one</span></tt> macro are stored as a hash inside the
parent in the parent’s database collection.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">),</span>
  <span class="s2">"label"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e0"</span><span class="p">),</span>
    <span class="s2">"name"</span> <span class="p">:</span> <span class="s2">"Mute"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can optionally tell Mongoid to store the embedded document in a different attribute other
than the name, by providing a <tt class="docutils literal"><span class="pre">:store_as</span></tt> option.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span><span class="p">,</span> <span class="n">store_as</span><span class="p">:</span> <span class="s2">"lab"</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="embeds-many">
<h3>Embeds Many<a class="headerlink" href="#embeds-many" title="Permalink to this headline">¶</a></h3>
<p>One to many relationships where the children are embedded in the parent document are defined
using Mongoid’s <tt class="docutils literal"><span class="pre">embeds_many</span></tt> and <tt class="docutils literal"><span class="pre">embedded_in</span></tt> macros.</p>
<div class="section" id="id3">
<h4>Defining<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The parent document of the relation should use the <tt class="docutils literal"><span class="pre">embeds_many</span></tt> macro to indicate it has n
number of embedded children, where the document that is embedded uses <tt class="docutils literal"><span class="pre">embedded_in</span></tt>. Definitions
are required on both sides to the relation in order for it to work properly.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>Storage<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>Documents that are embedded using the <tt class="docutils literal"><span class="pre">embeds_many</span></tt> macro are stored as an array of hashes
inside the parent in the parent’s database collection.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">),</span>
  <span class="s2">"albums"</span> <span class="p">:</span> <span class="o">[</span>
    <span class="p">{</span>
      <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e0"</span><span class="p">),</span>
      <span class="s2">"name"</span> <span class="p">:</span> <span class="s2">"Violator"</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="o">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can optionally tell Mongoid to store the embedded document in a different attribute other
than the name, by providing a <tt class="docutils literal"><span class="pre">:store_as</span></tt> option.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="n">store_as</span><span class="p">:</span> <span class="s2">"albs"</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="has-one">
<h3>Has One<a class="headerlink" href="#has-one" title="Permalink to this headline">¶</a></h3>
<p>One to one relationships where the children are referenced in the parent document are defined
using Mongoid’s <tt class="docutils literal"><span class="pre">has_one</span></tt> and <tt class="docutils literal"><span class="pre">belongs_to</span></tt> macros.</p>
<div class="section" id="id5">
<h4>Defining<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>The parent document of the relation should use the <tt class="docutils literal"><span class="pre">has_one</span></tt> macro to indicate is has 1 referenced
child, where the document that is referenced in it uses <tt class="docutils literal"><span class="pre">belongs_to</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_one</span> <span class="ss">:studio</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Studio</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Definitions are required on both sides to the relation in order for it to work properly, unless
one of the models is embedded.</p>
</div>
<div class="section" id="id6">
<h4>Storage<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>When defining a relation of this nature, each document is stored in its respective collection,
but the child document contains a “foreign key” reference to the parent.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># The parent band document.</span>
<span class="p">{</span> <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># The child studio document.</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7f1"</span><span class="p">),</span>
  <span class="s2">"band_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="has-many">
<h3>Has Many<a class="headerlink" href="#has-many" title="Permalink to this headline">¶</a></h3>
<p>One to many relationships where the children are stored in a separate collection from the parent
document are defined using Mongoid’s <tt class="docutils literal"><span class="pre">has_many</span></tt> and <tt class="docutils literal"><span class="pre">belongs_to</span></tt> macros. This exhibits similar
behavior to Active Record.</p>
<div class="section" id="id7">
<h4>Defining<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>The parent document of the relation should use the <tt class="docutils literal"><span class="pre">has_many</span></tt> macro to indicate is has n number
of referenced children, where the document that is referenced uses <tt class="docutils literal"><span class="pre">belongs_to</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_many</span> <span class="ss">:members</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Member</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Definitions are required on both sides to the relation in order for it to work properly,
unless one of the models is embedded.</p>
</div>
<div class="section" id="id8">
<h4>Storage<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>When defining a relation of this nature, each document is stored in its respective collection,
but the child document contains a “foreign key” reference to the parent.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># The parent band document.</span>
<span class="p">{</span> <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># A child member document.</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7f1"</span><span class="p">),</span>
  <span class="s2">"band_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="has-and-belongs-to-many">
<h3>Has And Belongs To Many<a class="headerlink" href="#has-and-belongs-to-many" title="Permalink to this headline">¶</a></h3>
<p>Many to many relationships where the inverse documents are stored in a separate collection
from the base document are defined using Mongoid’s <tt class="docutils literal"><span class="pre">has_and_belongs_to_many</span></tt> macro. This
exhibits similar behavior to Active Record with the exception that no join collection is needed,
the foreign key ids are stored as arrays on either side of the relation.</p>
<div class="section" id="id9">
<h4>Defining<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Both sides of the relation use the same macro.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:tags</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:bands</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can create a one sided many to many if you want to mimic a has_many that stores the keys
as an array on the parent.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:tags</span><span class="p">,</span> <span class="n">inverse_of</span><span class="p">:</span> <span class="kp">nil</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h4>Storage<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>When defining a relation of this nature, each document is stored in its respective collection,
and each document contains a “foreign key” reference to the other in the form of an array.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># The band document.</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">),</span>
  <span class="s2">"tag_ids"</span> <span class="p">:</span> <span class="o">[</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7f2"</span><span class="p">)</span> <span class="o">]</span>
<span class="p">}</span>

<span class="c1"># The tag document.</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7f2"</span><span class="p">),</span>
  <span class="s2">"band_ids"</span> <span class="p">:</span> <span class="o">[</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">"4d3ed089fb60ab534684b7e9"</span><span class="p">)</span> <span class="o">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="nested-attributes">
<h2>Nested Attributes<a class="headerlink" href="#nested-attributes" title="Permalink to this headline">¶</a></h2>
<p>Nested attributes provide a mechanism for updating documents and their relations in a
single operation, by nesting attributes in a single parameters hash. This is extremely
useful when wanting to edit multiple documents within a single web form.</p>
<div class="section" id="id11">
<h3>Common Behaviour<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>Nested attributes can be enabled for any relation, embedded or referenced. To enable this
for the relation, simply provide the relation name to the <tt class="docutils literal"><span class="pre">accepts_nested_attributes_for</span></tt> macro.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span>
  <span class="n">belongs_to</span> <span class="ss">:producer</span>
  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">:producer</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Note that when you add nested attributes functionality to a referenced relation, Mongoid
will automatically enable autosave for that relation.</p>
<p>When a relation gains nested attributes behavior, an additional method is added to the base
model, which should be used to update the attributes with the new functionality. This method
is the relation name plus <tt class="docutils literal"><span class="pre">_attributes=</span></tt>. You can use this method directly, or more commonly
the name of the method can be an attribute in the updates for the base class, in which case
Mongoid will call the appropriate setter under the covers.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">producer_attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Flood"</span> <span class="p">}</span>
<span class="n">band</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="n">producer_attributes</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Flood"</span> <span class="p">}}</span>
</pre></div>
</div>
<p>Note that this will work with any attribute based setter method in Mongoid. This includes:
<tt class="docutils literal"><span class="pre">update_attributes</span></tt>, <tt class="docutils literal"><span class="pre">update_attributes!</span></tt> and <tt class="docutils literal"><span class="pre">attributes=</span></tt>.</p>
</div>
</div>
<div class="section" id="callbacks">
<h2>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="document-callbacks">
<h3>Document Callbacks<a class="headerlink" href="#document-callbacks" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supports the following callbacks:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">after_initialize</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_build</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_validation</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_validation</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_create</span></tt></li>
<li><tt class="docutils literal"><span class="pre">around_create</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_create</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_find</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_update</span></tt></li>
<li><tt class="docutils literal"><span class="pre">around_update</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_update</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_upsert</span></tt></li>
<li><tt class="docutils literal"><span class="pre">around_upsert</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_upsert</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_save</span></tt></li>
<li><tt class="docutils literal"><span class="pre">around_save</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_save</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_destroy</span></tt></li>
<li><tt class="docutils literal"><span class="pre">around_destroy</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_destroy</span></tt></li>
</ul>
<p>Callbacks are available on any document, whether it is embedded within
another document or not. Note that to be efficient, Mongoid only fires
the callback of the document that the persistence action was executed on.
This is that Mongoid aims to support large hierarchies and to handle
optimized atomic updates callbacks can’t be firing all over the document
hierarchy.</p>
<p>Note that using callbacks for domain logic is a bad design practice, and can
lead to unexpected errors that are hard to debug when callbacks in
the chain halt execution. It is our recommendation to only use them
for cross-cutting concerns, like queueing up background jobs.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Article</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:slug</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">before_create</span> <span class="ss">:send_message</span>

  <span class="n">after_save</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
    <span class="c1"># Handle callback here.</span>
  <span class="k">end</span>

  <span class="kp">protected</span>
  <span class="k">def</span> <span class="nf">send_message</span>
    <span class="c1"># Message sending code here.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Callbacks are coming from Active Support, so you can use the new
syntax as well:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Article</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">set_callback</span><span class="p">(</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:before</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
    <span class="c1"># Message sending code here.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="relation-callbacks">
<h3>Relation Callbacks<a class="headerlink" href="#relation-callbacks" title="Permalink to this headline">¶</a></h3>
<p>Mongoid has a set of callbacks that are specific to collection based relations - these are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">after_add</span></tt></li>
<li><tt class="docutils literal"><span class="pre">after_remove</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_add</span></tt></li>
<li><tt class="docutils literal"><span class="pre">before_remove</span></tt></li>
</ul>
<p>Each time a document is added or removed from any of the following relations,
the respective callbacks are fired: <tt class="docutils literal"><span class="pre">embeds_many</span></tt>,
<tt class="docutils literal"><span class="pre">has_many</span></tt>, and <tt class="docutils literal"><span class="pre">has_and_belongs_to_many</span></tt>.</p>
<p>Relation Callbacks are specified as an option on the relation. The element added/removed
is the parameter to the method you call via the callback. Example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>

  <span class="n">has_many</span> <span class="ss">:posts</span><span class="p">,</span> <span class="n">after_add</span><span class="p">:</span> <span class="ss">:send_email_to_subscribers</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">send_email_to_subscribers</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
  <span class="no">Notifications</span><span class="o">.</span><span class="n">new_post</span><span class="p">(</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="validation">
<h2>Validation<a class="headerlink" href="#validation" title="Permalink to this headline">¶</a></h2>
<p>Mongoid includes <tt class="docutils literal"><span class="pre">ActiveModel::Validations</span></tt> to supply the basic
validation plus an additional associated and uniqueness validator.
<a class="reference external" href="http://rubygems.org/">Rubygems</a>.</p>
<p>See <a class="reference external" href="http://github.com/rails/rails/blob/master/activemodel/lib/active_model/validations.rb">ActiveModel::Validations</a> documentation for more information.</p>
<p>Mongoid behaves slightly different to Active Record when using <tt class="docutils literal"><span class="pre">#valid?</span></tt>
on already persisted data. Active Record’s <tt class="docutils literal"><span class="pre">#valid?</span></tt> will run all
validations whereas Mongoid’s <tt class="docutils literal"><span class="pre">#valid?</span></tt> will only run validations on
documents that are in memory as an optimization.</p>
</div>
<div class="section" id="id13">
<h2>Indexing<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>You can define indexes on documents using the index macro. Provide the key for
the index along with a direction. For additional options, supply them in a second
options hash parameter.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:ssn</span>

  <span class="n">index</span><span class="p">({</span> <span class="ss">ssn</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"ssn_index"</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can define indexes on embedded document fields as well.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">embeds_many</span> <span class="ss">:addresses</span>
  <span class="n">index</span> <span class="s2">"addresses.street"</span> <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can index on multiple fields and provide direction.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:first_name</span>
  <span class="n">field</span> <span class="ss">:last_name</span>

  <span class="n">index</span><span class="p">({</span> <span class="n">first_name</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Indexes can be sparse:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:ssn</span>

  <span class="n">index</span><span class="p">({</span> <span class="ss">ssn</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">sparse</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Indexes can be run in the background in cases where they may take some time:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:ssn</span>
  <span class="n">index</span><span class="p">({</span> <span class="ss">ssn</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">background</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>For unique indexes that are defined for a column that might already have duplicate
values, you can drop the duplicate entries:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:ssn</span>
  <span class="n">index</span><span class="p">({</span> <span class="ss">ssn</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">drop_dups</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>For geospatial indexes, make sure the field you are indexing is an Array.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">index</span><span class="p">({</span> <span class="ss">location</span><span class="p">:</span> <span class="s2">"2d"</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">min</span><span class="p">:</span> <span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="ss">max</span><span class="p">:</span> <span class="mi">200</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Indexes can be scoped to a specific database.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">field</span> <span class="ss">:ssn</span>
  <span class="n">index</span><span class="p">({</span> <span class="ss">ssn</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">database</span><span class="p">:</span> <span class="s2">"users"</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">background</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can have Mongoid define indexes for you on “foreign key” fields 
for relational associations. This only works on the relation macro that 
the foreign key is stored on.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
  <span class="n">belongs_to</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:preferences</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When you want to create the indexes in the database, use the provided rake task.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rake db:mongoid:create_indexes
</pre></div>
</div>
<p>Mongoid also provides a rake task to delete all secondary indexes.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rake db:mongoid:remove_indexes
</pre></div>
</div>
</div>
<div class="section" id="rails">
<h2>Rails<a class="headerlink" href="#rails" title="Permalink to this headline">¶</a></h2>
<p>Mongoid was built and targeted towards Rails applications, even though it will
work in any environment. However if you are using Rails consult the next sections
on how Mongoid hooks into a Rails application.</p>
<div class="section" id="railties">
<h3>Railties<a class="headerlink" href="#railties" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides some railties and initializers that one should be aware of when writing
a Rails application with Mongoid.</p>
<div class="section" id="id14">
<h4>Configuration<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>You can set Mongoid configuration options in your application.rb along with other Rails
environment specific options by accessing config.mongoid. Options set here will override
those set in your <tt class="docutils literal"><span class="pre">config/mongoid.yml</span></tt>.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Application</span>
    <span class="n">config</span><span class="o">.</span><span class="n">mongoid</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vg">$stdout</span><span class="p">,</span> <span class="ss">:warn</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">mongoid</span><span class="o">.</span><span class="n">persist_in_safe_mode</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="model-preloading">
<h4>Model Preloading<a class="headerlink" href="#model-preloading" title="Permalink to this headline">¶</a></h4>
<p>In order to properly set up single collection inheritance, Mongoid needs to preload all
models before every request in development mode. This can get slow, so if you are not
using any inheritance it is recommended you turn this feature off.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">mongoid</span><span class="o">.</span><span class="n">preload_models</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div>
</div>
</div>
<div class="section" id="exceptions">
<h4>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h4>
<p>Similar to Active Record, Mongoid tells raise to return specific http codes when some errors are raised.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Errors</span><span class="o">::</span><span class="no">DocumentNotFound</span> <span class="p">:</span> <span class="mi">404</span>
<span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Errors</span><span class="o">::</span><span class="no">Validations</span> <span class="p">:</span> <span class="mi">422</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rake-tasks">
<h3>Rake Tasks<a class="headerlink" href="#rake-tasks" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides the following rake tasks when used in a Rails 3 environment:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">db:create</span></tt>: Exists only for dependency purposes, does not actually do anything.</li>
<li><tt class="docutils literal"><span class="pre">db:create_indexes</span></tt>: Reads all index definitions from the models and attempts to create them in the database.</li>
<li><tt class="docutils literal"><span class="pre">db:remove_indexes</span></tt>: Reads all secondary index definitions from the models.</li>
<li><tt class="docutils literal"><span class="pre">db:drop</span></tt>: Drops all collections in the database with the exception of the system collections.</li>
<li><tt class="docutils literal"><span class="pre">db:migrate</span></tt>: Exists only for dependency purposes, does not actually do anything.</li>
<li><tt class="docutils literal"><span class="pre">db:purge</span></tt>: Deletes all data, including indexes, from the database. Since 3.1.0</li>
<li><tt class="docutils literal"><span class="pre">db:schema:load</span></tt>: Exists only for framework dependency purposes, does not actually do anything.</li>
<li><tt class="docutils literal"><span class="pre">db:seed</span></tt>: Seeds the database from db/seeds.rb</li>
<li><tt class="docutils literal"><span class="pre">db:setup</span></tt>: Creates indexes and seeds the database.</li>
<li><tt class="docutils literal"><span class="pre">db:test:prepare</span></tt>: Exists only for framework dependency purposes, does not actually do anything.</li>
</ul>
</div>
</div>
<div class="section" id="upgrading">
<h2>Upgrading<a class="headerlink" href="#upgrading" title="Permalink to this headline">¶</a></h2>
<div class="section" id="upgrading-to-5-0-0">
<h3>Upgrading to 5.0.0<a class="headerlink" href="#upgrading-to-5-0-0" title="Permalink to this headline">¶</a></h3>
<p>The underlying driver has changed from Moped to the official MongoDB Ruby driver.
For all users dropping down to the driver level for operations, please see the driver
documentation for help with that API.</p>
<p>All Mongoid configuration options have changed, as the underlying driver has changed
from Moped to the core MongoDB Ruby driver. Please see the
<a class="reference external" href="#anatomy-of-a-mongoid-config">configuration section</a> for a detailed description of all new options.</p>
<p>All references to session are now replaced with client. This includes the <tt class="docutils literal"><span class="pre">mongoid.yml</span></tt>
configuration, <tt class="docutils literal"><span class="pre">store_in</span></tt> options, and all exceptions and modules with Session in the name.</p>
<p><tt class="docutils literal"><span class="pre">find_and_modify</span></tt> has been removed and replaced with 3 options: <tt class="docutils literal"><span class="pre">find_one_and_update</span></tt>,
<tt class="docutils literal"><span class="pre">find_one_and_delete</span></tt> and <tt class="docutils literal"><span class="pre">find_one_and_replace</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">text_search</span></tt> has been removed as it is now a $text option in a query from 2.6 on.</p>
<p>Mongoid no longer supports MongoDB 2.2 - support is now for only 2.4 and higher.</p>
<p><tt class="docutils literal"><span class="pre">first</span></tt> and <tt class="docutils literal"><span class="pre">last</span></tt> no longer add an <tt class="docutils literal"><span class="pre">_id</span></tt> sort when no sorting options have been
provided. In order to guarantee that a document is the first or last, it needs to now
contain an explicit sort.</p>
</div>
</div>
</div>

                
    <div id="btnv">
      <span class="btn-arrow-left">← &nbsp;</span>
      <a class="btn-prev-text" href="http://docs.mongodb.org/ecosystem/tutorial/ruby-bson-tutorial/" title="Previous Section: Ruby BSON Tutorial (3.0.0)"><span>Ruby BSON Tutorial (3.0.0)</span></a>
      <a class="btn-next-text" href="http://docs.mongodb.org/ecosystem/drivers/scala/" title="Next Section: Scala MongoDB Driver"><span>Scala MongoDB Driver</span></a>
      <span class="btn-arrow-right">&nbsp;→</span>
    </div><!-- if anything changes in the rating block, update the doctools.js in themes/mongodb/static -->
                
                  <div class="footer">
                    <div class="copyright">
                      <p>Copyright © 2011-2015 <a class="smalltext" href="https://www.mongodb.com/">MongoDB, Inc</a>. Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons</a>. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper">
             <div class="toc">
               <span class="toc-header">ON THIS PAGE</span>
               <ul>
<li><a class="reference internal" href="#">Mongoid Tutorial (5.0.0)</a><ul>
<li><a class="reference internal" href="#installation">Installation</a><ul>
<li><a class="reference internal" href="#installing-the-gem">Installing The Gem</a></li>
<li><a class="reference internal" href="#compatibility">Compatibility</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a><ul>
<li><a class="reference internal" href="#rails-applications">Rails Applications</a></li>
<li><a class="reference internal" href="#anatomy-of-a-mongoid-config">Anatomy of a Mongoid Config</a></li>
<li><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#documents">Documents</a><ul>
<li><a class="reference internal" href="#storage">Storage</a></li>
<li><a class="reference internal" href="#fields">Fields</a><ul>
<li><a class="reference internal" href="#accessing-field-values">Accessing Field Values</a></li>
<li><a class="reference internal" href="#hash-fields">Hash Fields</a></li>
<li><a class="reference internal" href="#defaults">Defaults</a></li>
<li><a class="reference internal" href="#aliasing-fields">Aliasing Fields</a></li>
<li><a class="reference internal" href="#custom-fields">Custom Fields</a></li>
<li><a class="reference internal" href="#reserved-names">Reserved Names</a></li>
<li><a class="reference internal" href="#custom-ids">Custom Ids</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dynamic-fields">Dynamic Fields</a></li>
<li><a class="reference internal" href="#localized-fields">Localized Fields</a><ul>
<li><a class="reference internal" href="#fallbacks">Fallbacks</a></li>
<li><a class="reference internal" href="#querying">Querying</a></li>
<li><a class="reference internal" href="#indexing">Indexing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dirty-tracking">Dirty Tracking</a><ul>
<li><a class="reference internal" href="#viewing-changes">Viewing Changes</a></li>
<li><a class="reference internal" href="#resetting-changes">Resetting Changes</a></li>
<li><a class="reference internal" href="#notes-on-persistence">Notes On Persistence</a></li>
<li><a class="reference internal" href="#viewing-previous-changes">Viewing Previous Changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#readonly-attributes">Readonly Attributes</a></li>
<li><a class="reference internal" href="#inheritance">Inheritance</a><ul>
<li><a class="reference internal" href="#querying-subclasses">Querying Subclasses</a></li>
<li><a class="reference internal" href="#associations">Associations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#timestamping">Timestamping</a></li>
</ul>
</li>
<li><a class="reference internal" href="#persistence">Persistence</a><ul>
<li><a class="reference internal" href="#standard">Standard</a></li>
<li><a class="reference internal" href="#atomic">Atomic</a></li>
<li><a class="reference internal" href="#custom">Custom</a><ul>
<li><a class="reference internal" href="#model-level-persistence-options">Model Level Persistence Options</a></li>
<li><a class="reference internal" href="#runtime-persistence-options">Runtime Persistence Options</a></li>
<li><a class="reference internal" href="#client-and-collection-access">Client and Collection Access</a></li>
<li><a class="reference internal" href="#capped-collections">Capped Collections</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Querying</a><ul>
<li><a class="reference internal" href="#queries">Queries</a><ul>
<li><a class="reference internal" href="#queryable-dsl">Queryable DSL</a></li>
<li><a class="reference internal" href="#additional-query-methods">Additional Query Methods</a></li>
<li><a class="reference internal" href="#eager-loading">Eager Loading</a></li>
</ul>
</li>
<li><a class="reference internal" href="#queries-persistence">Queries + Persistence</a></li>
<li><a class="reference internal" href="#scoping">Scoping</a><ul>
<li><a class="reference internal" href="#named-scopes">Named Scopes</a></li>
<li><a class="reference internal" href="#default-scopes">Default Scopes</a></li>
<li><a class="reference internal" href="#class-methods">Class Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#map-reduce">Map/Reduce</a><ul>
<li><a class="reference internal" href="#execution">Execution</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#relations">Relations</a><ul>
<li><a class="reference internal" href="#common-behaviour">Common Behaviour</a><ul>
<li><a class="reference internal" href="#attributes">Attributes</a></li>
<li><a class="reference internal" href="#extensions">Extensions</a></li>
<li><a class="reference internal" href="#custom-relation-names">Custom Relation Names</a></li>
<li><a class="reference internal" href="#validations">Validations</a></li>
<li><a class="reference internal" href="#polymorphism">Polymorphism</a></li>
<li><a class="reference internal" href="#cascading-callbacks">Cascading Callbacks</a></li>
<li><a class="reference internal" href="#dependent-behaviour">Dependent Behaviour</a></li>
<li><a class="reference internal" href="#autosaving">Autosaving</a></li>
<li><a class="reference internal" href="#recursive-embedding">Recursive Embedding</a></li>
<li><a class="reference internal" href="#existence-predicates">Existence Predicates</a></li>
<li><a class="reference internal" href="#autobuilding">Autobuilding</a></li>
<li><a class="reference internal" href="#touching">Touching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metadata">Metadata</a><ul>
<li><a class="reference internal" href="#the-metadata-object">The Metadata Object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#embeds-one">Embeds One</a><ul>
<li><a class="reference internal" href="#defining">Defining</a></li>
<li><a class="reference internal" href="#id2">Storage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#embeds-many">Embeds Many</a><ul>
<li><a class="reference internal" href="#id3">Defining</a></li>
<li><a class="reference internal" href="#id4">Storage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#has-one">Has One</a><ul>
<li><a class="reference internal" href="#id5">Defining</a></li>
<li><a class="reference internal" href="#id6">Storage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#has-many">Has Many</a><ul>
<li><a class="reference internal" href="#id7">Defining</a></li>
<li><a class="reference internal" href="#id8">Storage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#has-and-belongs-to-many">Has And Belongs To Many</a><ul>
<li><a class="reference internal" href="#id9">Defining</a></li>
<li><a class="reference internal" href="#id10">Storage</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#nested-attributes">Nested Attributes</a><ul>
<li><a class="reference internal" href="#id11">Common Behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#callbacks">Callbacks</a><ul>
<li><a class="reference internal" href="#document-callbacks">Document Callbacks</a></li>
<li><a class="reference internal" href="#relation-callbacks">Relation Callbacks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation">Validation</a></li>
<li><a class="reference internal" href="#id13">Indexing</a></li>
<li><a class="reference internal" href="#rails">Rails</a><ul>
<li><a class="reference internal" href="#railties">Railties</a><ul>
<li><a class="reference internal" href="#id14">Configuration</a></li>
<li><a class="reference internal" href="#model-preloading">Model Preloading</a></li>
<li><a class="reference internal" href="#exceptions">Exceptions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rake-tasks">Rake Tasks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading">Upgrading</a><ul>
<li><a class="reference internal" href="#upgrading-to-5-0-0">Upgrading to 5.0.0</a></li>
</ul>
</li>
</ul>
</li>
</ul>

             </div>
          <div class="report-link">
            <a class="jira-link jirafeedback" href="https://jira.mongodb.org/secure/CreateIssueDetails%21init.jspa?pid=10380&amp;issuetype=4&amp;priority=4&amp;summary=Comment+on%3a+%22tutorial/ruby-mongoid-tutorial%2Etxt%22" target="_blank" title="Report a problem with tutorial/ruby-mongoid-tutorial.txt on Jira">Report a Problem</a>
          </div>
        
           <div class="social">
             <a class="twitter-icon" href="https://twitter.com/mongodbinc"><i class="fa fa-twitter-square"></i></a>
             <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB"><i class="fa fa-youtube-square"></i></a>
             <a class="facebook-icon" href="https://www.facebook.com/mongodb"><i class="fa fa-facebook-square"></i></a>
             <a class="gplus-icon" href="https://plus.google.com/u/1/101024085748034940765/posts?cfem=1"><i class="fa fa-google-plus-square"></i></a>
           </div>
        
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
  <script type="text/javascript">
document.write(unescape("%3Cscript src='" + document.location.protocol + "https://munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/munchkin.html" type="text/javascript"></script><script id="" type="text/javascript">adroll_adv_id="VC7KN272KJFYNCZSKCA7GR";adroll_pix_id="3L5E5MU7GBC3NMYB75WIRR";(function(){var b=window.onload;window.onload=function(){__adroll_loaded=!0;var a=document.createElement("script"),c="https:"==document.location.protocol?"https://s.adroll.com":"http://a.adroll.com";a.setAttribute("async","true");a.type="text/javascript";a.src=c+"/j/roundtrip.js";((document.getElementsByTagName("head")||[null])[0]||document.getElementsByTagName("script")[0].parentNode).appendChild(a);b&&b()}})();</script><script src="Mongoid%20Tutorial%20%285.0.0%29_files/2182330138.js" id="" type="text/javascript"></script><script id="" type="text/javascript">var _elqQ=_elqQ||[];_elqQ.push(["elqSetSiteId","413370795"]);_elqQ.push(["elqTrackPageView"]);(function(){var a=document.createElement("script");a.type="text/javascript";a.async=!0;a.src="//img03.en25.com/i/elqCfg.min.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})();</script><script id="" type="text/javascript">_bizo_data_partner_id="6855";</script>
<script id="" type="text/javascript">(function(){var b=document.getElementsByTagName("script")[0],a=document.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===window.location.protocol?"https://sjs":"http://js")+".bizographics.com/insight.min.js";b.parentNode.insertBefore(a,b)})();</script>
<noscript>
  <img height="1" width="1" alt="" style="display:none;" src="//www.bizographics.com/collect/?pid=6855&amp;fmt=gif">
</noscript><script src="Mongoid%20Tutorial%20%285.0.0%29_files/pix.js" id="" type="text/javascript"></script>
<script>try { mktoMunchkin("017-HGS-593"); } catch(e) {}</script><script type="text/javascript">
jQuery.ajax({
         url: "https://jira.mongodb.org/s/en_UScn8g8x/782/6/1.2.5/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?collectorId=298ba4e7",
         type: "get",
         cache: true,
         dataType: "script"
        });
window.ATL_JQ_PAGE_PROPS =  {
        "triggerFunction": function(showCollectorDialog) {
                jQuery(".jirafeedback").click(function(e) {e.preventDefault();showCollectorDialog();});},
                fieldValues: {component: 'mongodb-ecosystem', summary: 'Comment on: "mongodb-ecosystem/tutorial/ruby-mongoid-tutorial.txt"'},
                environment: {'repo': 'docs-ecosystem','source': 'tutorial/ruby-mongoid-tutorial'}
                };
</script>

  <script type="text/javascript">
  var pagename = 'tutorial/ruby-mongoid-tutorial';
  if (pagename == 'index') {
    pagename = '';
  }
  window.basePath = '';

  window.fullDocsPath = function(base) {
    var path = pagename;

    // skip if pagename is undefined (index.html)
    if (path) {
      path = pagename + '/';
    }
    return '/' + base + '/' + path;
  }
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = ['/drivers', '/drivers/c', '/drivers/cpp', '/drivers/csharp', '/drivers/go', '/drivers/erlang', '/drivers/node-js', '/drivers/perl', '/drivers/php', '/drivers/python', '/drivers/ruby', '/drivers/scala'];

  $(document).ready(function(){
    $(".version-selector").on('click', function(e) {
      e.preventDefault();
      var base = $(e.currentTarget).data('path');
      window.location.href = fullDocsPath(base);
    });

    $("select.language-selector").on('change', function(e) {
      var path = $(e.currentTarget).find('option:selected').data('path');
      window.location.href = path;
    });
  });

  </script>
<script type="text/javascript" src="Mongoid%20Tutorial%20%285.0.0%29_files/a"></script><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/pixel.gif" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/pxj.gif" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/tap.gif" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/usersync.gif" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/1.png" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/rtset.gif" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/rum.gif" height="1" width="1"><img style="display: none;" src="Mongoid%20Tutorial%20%285.0.0%29_files/usync.png" height="1" width="1"><table class="gstl_50 gssb_c" style="width: 19px; display: none; top: 39px; left: 970px; position: absolute;" cellpadding="0" cellspacing="0"><tbody><tr><td class="gssb_f"></td><td style="width: 100%;" class="gssb_e"></td></tr></tbody></table><div style="display: none;" id="atlwdg-blanket" class="atlwdg-blanket"></div><div class="atlwdg-popup atlwdg-box-shadow atlwdg-hidden" id="atlwdg-container"></div><img style="display: none;" alt="" src="Mongoid%20Tutorial%20%285.0.0%29_files/l.gif" border="0" height="1" width="1"></body></html>